<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRC Wallet - Quantum Resistant Blockchain</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%2300ff88' rx='20'/></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%); color: #ffffff; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        /* Login Screen Styles */
        .login-container { 
            width: 100%; 
            max-width: 400px; 
            background: rgba(255, 255, 255, 0.05); 
            padding: 40px; 
            border-radius: 24px; 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            margin-top: 100px;
        }
        .login-logo { text-align: center; margin-bottom: 30px; }
        .login-logo .logo { width: 80px; height: 80px; background: #00ff88; border-radius: 20px; display: inline-flex; align-items: center; justify-content: center; font-size: 36px; font-weight: bold; color: #000; margin-bottom: 20px; }
        .login-title { font-size: 24px; text-align: center; margin-bottom: 10px; }
        .login-subtitle { color: #999; text-align: center; margin-bottom: 30px; }
        .input-group { margin-bottom: 20px; }
        .input-label { display: block; margin-bottom: 8px; color: #999; font-size: 14px; }
        .input-field { width: 100%; padding: 15px; border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 8px; background: rgba(255, 255, 255, 0.05); color: white; font-size: 16px; transition: all 0.3s; }
        .input-field:focus { outline: none; border-color: #00ff88; background: rgba(255, 255, 255, 0.08); }
        .password-toggle { position: relative; }
        .password-toggle-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #999; cursor: pointer; font-size: 20px; }
        .error-message { background: rgba(255, 107, 107, 0.1); border: 1px solid #ff6b6b; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; display: none; }
        .success-message { background: rgba(0, 255, 136, 0.1); border: 1px solid #00ff88; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; display: none; }
        
        /* Main App Styles */
        .app-container { width: 100%; display: none; }
        .main-header { width: 100%; max-width: 1200px; display: flex; justify-content: space-between; align-items: center; margin: 0 auto 40px; padding: 20px 0; }
        .logo-section { display: flex; align-items: center; gap: 15px; }
        .logo { width: 50px; height: 50px; background: #00ff88; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #000; }
        .logo-text { font-size: 24px; font-weight: 700; }
        .nav-links { display: flex; gap: 30px; align-items: center; }
        .nav-link { color: #999; text-decoration: none; transition: color 0.3s; font-size: 14px; cursor: pointer; }
        .nav-link:hover { color: #00ff88; }
        .user-menu { display: flex; align-items: center; gap: 20px; }
        .user-info { display: flex; align-items: center; gap: 10px; padding: 8px 16px; background: rgba(255, 255, 255, 0.05); border-radius: 20px; }
        .user-avatar { width: 32px; height: 32px; background: #00ff88; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #000; }
        .logout-btn { background: none; border: 1px solid #ff6b6b; color: #ff6b6b; padding: 8px 16px; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .logout-btn:hover { background: #ff6b6b; color: white; }
        .network-indicator { display: flex; align-items: center; gap: 8px; background: rgba(0, 255, 136, 0.1); padding: 8px 16px; border-radius: 20px; font-size: 12px; }
        .network-dot { width: 8px; height: 8px; background: #00ff88; border-radius: 50%; animation: pulse 2s infinite; }
        .main-content { width: 100%; max-width: 1200px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin: 0 auto 40px; }
        .stats-section { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .stat-card { background: rgba(255, 255, 255, 0.05); padding: 24px; border-radius: 16px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); background: rgba(255, 255, 255, 0.08); }
        .stat-value { font-size: 32px; font-weight: 700; color: #00ff88; margin-bottom: 5px; }
        .stat-label { font-size: 12px; color: #999; text-transform: uppercase; letter-spacing: 1px; }
        .wallet-section { background: rgba(255, 255, 255, 0.05); padding: 40px; border-radius: 24px; backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); }
        .wallet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .wallet-title { font-size: 20px; font-weight: 600; }
        .wallet-menu { display: flex; gap: 10px; }
        .menu-button { background: none; border: none; color: #999; cursor: pointer; padding: 8px; transition: color 0.3s; }
        .menu-button:hover { color: #00ff88; }
        .security-status { display: flex; align-items: center; gap: 10px; background: rgba(0, 255, 136, 0.1); padding: 8px 16px; border-radius: 20px; margin-bottom: 20px; }
        .security-icon { color: #00ff88; }
        .algorithm-badge { display: inline-flex; align-items: center; gap: 8px; background: rgba(0, 255, 136, 0.1); padding: 6px 12px; border-radius: 20px; font-size: 12px; color: #00ff88; margin-bottom: 20px; }
        .algorithm-badge .badge-icon { width: 16px; height: 16px; background: #00ff88; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #000; font-weight: bold; }
        .wallet-display { background: rgba(0, 0, 0, 0.3); padding: 24px; border-radius: 16px; margin-bottom: 30px; }
        .wallet-address-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .wallet-label { font-size: 12px; color: #999; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .wallet-address { font-family: 'Courier New', monospace; font-size: 14px; word-break: break-all; cursor: pointer; transition: color 0.3s; }
        .wallet-address:hover { color: #00ff88; }
        .address-actions { display: flex; gap: 10px; }
        .balance-display { text-align: center; padding: 30px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 30px; }
        .balance-label { font-size: 14px; color: #999; margin-bottom: 10px; }
        .balance-amount { font-size: 48px; font-weight: 700; background: linear-gradient(45deg, #00ff88, #00ffff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
        .balance-usd { font-size: 18px; color: #999; }
        .button { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .button-primary { background: linear-gradient(45deg, #00ff88, #00cc77); color: #000; }
        .button-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 255, 136, 0.3); }
        .button-secondary { background: transparent; color: #00ff88; border: 2px solid #00ff88; }
        .button-secondary:hover { background: #00ff88; color: #000; }
        .tabs { display: flex; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 30px; }
        .tab { padding: 12px 24px; cursor: pointer; color: #999; transition: all 0.3s; border-bottom: 2px solid transparent; }
        .tab.active { color: #00ff88; border-bottom-color: #00ff88; }
        .tab:hover { color: #00ff88; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Security Section Styles */
        .security-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .security-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .security-item-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .status-enabled {
            background: #00ff88;
        }
        .status-disabled {
            background: #ff6b6b;
        }
        .security-item h3 {
            margin: 0;
            font-size: 16px;
        }
        .security-item p {
            color: #999;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .dropdown {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: rgba(26, 26, 62, 0.95);
            min-width: 100%;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.3);
            border-radius: 8px;
            z-index: 1;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-height: 200px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        .dropdown-content.show {
            display: block;
        }
        .dropdown-item {
            color: #fff;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.3s;
        }
        .dropdown-item:hover {
            background-color: rgba(0, 255, 136, 0.1);
        }
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        /* Session Management Styles */
        .session-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .session-current {
            border: 1px solid #00ff88;
        }
        .session-info {
            flex: 1;
        }
        .session-device {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .session-details {
            font-size: 12px;
            color: #999;
        }
        .session-time {
            font-size: 11px;
            color: #666;
            margin-top: 3px;
        }
        .auto-lock-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .lock-option {
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        .lock-option:hover {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }
        .lock-option.selected {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.2);
        }
        
        .transaction-item { background: rgba(255, 255, 255, 0.05); padding: 16px; border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; animation: fadeIn 0.3s ease-out; }
        .transaction-item:hover { background: rgba(255, 255, 255, 0.08); }
        .transaction-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 15px; }
        .transaction-icon.received { background: rgba(0, 255, 136, 0.1); color: #00ff88; }
        .transaction-icon.sent { background: rgba(255, 107, 107, 0.1); color: #ff6b6b; }
        .transaction-details { flex: 1; }
        .transaction-type { font-weight: 600; margin-bottom: 4px; }
        .transaction-address { font-size: 12px; color: #999; font-family: monospace; }
        .transaction-time { font-size: 11px; color: #666; margin-top: 4px; }
        .transaction-amount { text-align: right; }
        .transaction-value { font-weight: 600; font-size: 16px; }
        .transaction-value.positive { color: #00ff88; }
        .transaction-value.negative { color: #ff6b6b; }
        .transaction-usd { font-size: 12px; color: #999; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state-icon { font-size: 48px; margin-bottom: 20px; opacity: 0.5; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-content { background: #1a1a3e; padding: 40px; border-radius: 24px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; animation: fadeIn 0.3s ease-out; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .modal-title { font-size: 24px; font-weight: 600; }
        .close-modal { background: none; border: none; color: #999; font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s; }
        .close-modal:hover { background: rgba(255, 255, 255, 0.1); color: #fff; }
        .qr-container { background: #fff; padding: 30px; border-radius: 16px; text-align: center; }
        .qr-title { color: #000; font-size: 18px; margin-bottom: 20px; }
        #qrcode, #receiveQrcode { margin: 0 auto 20px; display: inline-block; }
        .qr-address { background: #f5f5f5; padding: 12px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; color: #000; word-break: break-all; margin-bottom: 20px; }
        .notification { position: fixed; bottom: 20px; right: 20px; background: #00ff88; color: #000; padding: 16px 24px; border-radius: 12px; font-weight: 600; animation: slideIn 0.3s ease-out; display: none; z-index: 2000; max-width: 400px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); }
        .notification.error { background: #ff6b6b; color: #fff; }
        .notification.warning { background: #ffa500; color: #000; }
        .notification.info { background: #3498db; color: #fff; }
        .notification.success { background: #00ff88; color: #000; }
        
        /* 2FA Styles */
        .two-factor-setup {
            text-align: center;
            padding: 20px;
        }
        .qr-code-2fa {
            margin: 20px auto;
            background: white;
            padding: 10px;
            border-radius: 8px;
            display: inline-block;
        }
        .manual-code {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 16px;
            letter-spacing: 2px;
            color: #00ff88;
            margin: 15px 0;
            word-break: break-all;
        }
        .backup-codes {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
        }
        .backup-code {
            display: block;
            margin: 5px 0;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: #00ff88;
        }
        
        /* Wallet Connect Buttons */
        .wallet-connect-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }
        .wallet-connect-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #00ff88;
            transform: translateY(-2px);
        }
        .wallet-connect-btn img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }
        .seed-input {
            width: 100%;
            font-family: monospace;
            font-size: 14px;
            transition: all 0.3s;
        }
        .seed-input:focus {
            border-color: #00ff88 !important;
            outline: none;
        }
        .seed-input:valid {
            border-color: rgba(0, 255, 136, 0.3) !important;
        }
        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }
        .connection-status.error {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
        }
        
        /* Custom Select Dropdown Styles */
        select.custom-select {
            width: auto;
            padding: 8px 32px 8px 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23999999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
        }
        
        select.custom-select:hover {
            background-color: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        select.custom-select:focus {
            outline: none;
            border-color: #00ff88;
            background-color: rgba(255, 255, 255, 0.08);
        }
        
        select.custom-select option {
            background: #1a1a3e;
            color: white;
            padding: 10px;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.8; } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        
        @media (max-width: 968px) { 
            .main-content { grid-template-columns: 1fr; } 
            .main-header { flex-direction: column; gap: 20px; }
            .nav-links { flex-wrap: wrap; justify-content: center; }
        }
        @media (max-width: 768px) { 
            .stats-section { grid-template-columns: 1fr; } 
            .wallet-section { padding: 24px; } 
            .balance-amount { font-size: 36px; }
            .transaction-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .transaction-amount { align-self: flex-end; }
            .security-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-logo">
            <div class="logo">QRC</div>
        </div>
        <h1 class="login-title">Quantum Wallet</h1>
        <p class="login-subtitle">Secure access to your quantum-resistant blockchain</p>
        
        <div class="error-message" id="loginError"></div>
        <div class="success-message" id="loginSuccess"></div>
        
        <div id="loginForm">
            <div class="input-group">
                <label class="input-label">Wallet Password</label>
                <div class="password-toggle">
                    <input type="password" class="input-field" id="walletPassword" placeholder="Enter your secure password">
                    <button class="password-toggle-btn" onclick="togglePassword('walletPassword')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="input-group" id="login2FAField" style="display: none;">
                <label class="input-label">2FA Code</label>
                <input type="text" class="input-field" id="login2FA" placeholder="000000" maxlength="6" style="text-align: center;">
            </div>
            
            <button class="button button-primary" onclick="attemptLogin()">
                <span>🔐</span>
                <span>Unlock Wallet</span>
            </button>
            
            <button class="button button-secondary" onclick="showCreateNewWallet()">
                <span>✨</span>
                <span>Create New Wallet</span>
            </button>
            
            <button class="button button-secondary" onclick="showImportWallet()">
                <span>📥</span>
                <span>Import Existing Wallet</span>
            </button>
        </div>
        
        <div id="createWalletForm" style="display: none;">
            <div class="input-group">
                <label class="input-label">Create Password (min 8 characters)</label>
                <div class="password-toggle">
                    <input type="password" class="input-field" id="newPassword" placeholder="Create a strong password">
                    <button class="password-toggle-btn" onclick="togglePassword('newPassword')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="input-group">
                <label class="input-label">Confirm Password</label>
                <div class="password-toggle">
                    <input type="password" class="input-field" id="confirmPassword" placeholder="Confirm your password">
                    <button class="password-toggle-btn" onclick="togglePassword('confirmPassword')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <button class="button button-primary" onclick="createNewWallet()">
                <span>🚀</span>
                <span>Create Secure Wallet</span>
            </button>
            
            <button class="button button-secondary" onclick="backToLogin()">
                <span>←</span>
                <span>Back to Login</span>
            </button>
        </div>
        
        <div id="importWalletForm" style="display: none;">
            <div style="margin-bottom: 20px;">
                <p style="color: #999; text-align: center; margin-bottom: 20px;">Connect your existing wallet</p>
                <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                    <button class="wallet-connect-btn" onclick="connectMetaMask()" style="width: 200px;">
                        <svg width="24" height="24" viewBox="0 0 35 33" xmlns="http://www.w3.org/2000/svg">
                            <g stroke-linecap="round" stroke-linejoin="round" stroke-width="1">
                                <path d="m32.9582 1-13.1341 9.7183 2.4424-5.72731z" fill="#e17726" stroke="#e17726"/>
                                <g fill="#e27625" stroke="#e27625">
                                    <path d="m2.66296 1 13.01714 9.809-2.3254-5.81802z"/>
                                    <path d="m28.2295 23.5335-3.4947 5.3386 7.4829 2.0603 2.1436-7.2823z"/>
                                    <path d="m1.27281 23.6501 2.13055 7.2823 7.46994-2.0603-3.48166-5.3386z"/>
                                    <path d="m10.4706 14.5149-2.0786 3.1358 7.405.3369-.2469-7.969z"/>
                                    <path d="m25.1505 14.5149-5.1575-4.58704-.1688 8.05974 7.4049-.3369z"/>
                                    <path d="m10.8733 28.8721 4.4819-2.1639-3.8583-3.0062z"/>
                                    <path d="m20.2659 26.7082 4.4689 2.1639-.6105-5.1701z"/>
                                </g>
                                <path d="m24.7348 28.8721-4.469-2.1639.3638 2.9025-.039 1.231z" fill="#d5bfb2" stroke="#d5bfb2"/>
                                <path d="m10.8732 28.8721 4.1572 1.9696-.026-1.231.3508-2.9025z" fill="#d5bfb2" stroke="#d5bfb2"/>
                                <path d="m15.1084 21.7842-3.7155-1.0884 2.6243-1.2051z" fill="#233447" stroke="#233447"/>
                                <path d="m20.5126 21.7842 1.0913-2.2935 2.6372 1.2051z" fill="#233447" stroke="#233447"/>
                                <path d="m10.8733 28.8721.6495-5.3386-4.13117.1167z" fill="#cc6228" stroke="#cc6228"/>
                                <path d="m24.0982 23.5335.6366 5.3386 3.4946-5.2219z" fill="#cc6228" stroke="#cc6228"/>
                                <path d="m27.2291 17.6507-7.405.3369.6885 3.7966 1.0913-2.2935 2.6372 1.2051z" fill="#cc6228" stroke="#cc6228"/>
                                <path d="m11.3929 20.6958 2.6242-1.2051 1.0913 2.2935.6885-3.7966-7.40495-.3369z" fill="#cc6228" stroke="#cc6228"/>
                                <path d="m8.392 17.6507 3.1049 6.0513-.1039-3.0062z" fill="#e27525" stroke="#e27525"/>
                                <path d="m24.2412 20.6958-.1169 3.0062 3.1049-6.0513z" fill="#e27525" stroke="#e27525"/>
                                <path d="m15.797 17.9876-.6886 3.7967.8704 4.4833.1949-5.9087z" fill="#e27525" stroke="#e27525"/>
                                <path d="m19.8242 17.9876-.3638 2.3584.1819 5.9216.8704-4.4833z" fill="#e27525" stroke="#e27525"/>
                                <path d="m20.5127 21.7842-.8704 4.4834.6236.4406 3.8584-3.0062.1169-3.0062z" fill="#f5841f" stroke="#f5841f"/>
                                <path d="m11.3929 20.6958.104 3.0062 3.8583 3.0062.6236-.4406-.8704-4.4834z" fill="#f5841f" stroke="#f5841f"/>
                                <path d="m20.5906 30.8417.039-1.231-.3378-.2851h-4.9626l-.3248.2851.026 1.231-4.1572-1.9696 1.4551 1.1921 2.9489 2.0344h5.0536l2.962-2.0344 1.442-1.1921z" fill="#c0ac9d" stroke="#c0ac9d"/>
                                <path d="m20.2659 26.7082-.6236-.4406h-3.6635l-.6236.4406-.3508 2.9025.3248-.2851h4.9626l.3378.2851z" fill="#161616" stroke="#161616"/>
                                <path d="m33.5168 11.3532 1.1043-5.36447-1.6629-4.98873-12.6923 9.3944 4.8846 4.1205 6.8983 2.0085 1.52-1.7752-.6626-.4795 1.0523-.9588-.8054-.622 1.0523-.8034z" fill="#763e1a" stroke="#763e1a"/>
                                <path d="m1 5.98873 1.11724 5.36447-.71451.5313 1.06527.8034-.80545.622 1.05228.9588-.66255.4795 1.51997 1.7752 6.89835-2.0085 4.8846-4.1205-12.69233-9.3944z" fill="#763e1a" stroke="#763e1a"/>
                                <path d="m32.0489 16.5234-6.8983-2.0085 2.0786 3.1358-3.1049 6.0513 4.1052-.0519h6.1318z" fill="#f5841f" stroke="#f5841f"/>
                                <path d="m10.4705 14.5149-6.89828 2.0085-2.29944 7.1267h6.11883l4.10519.0519-3.10487-6.0513z" fill="#f5841f" stroke="#f5841f"/>
                                <path d="m19.8241 17.9876.4417-7.5932 2.0007-5.4034h-8.9119l2.0006 5.4034.4417 7.5932.1689 2.3842.013 5.8958h3.6635l.013-5.8958z" fill="#f5841f" stroke="#f5841f"/>
                            </g>
                        </svg>
                        <span>MetaMask</span>
                    </button>
                </div>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <span style="color: #666;">— OR —</span>
            </div>
            
            <div class="input-group">
                <label class="input-label">Import with 24-Word Seed Phrase</label>
                <div class="seed-phrase-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                    <input type="text" class="seed-input" placeholder="1" id="seed1" onkeyup="moveToNext(event, 1)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="2" id="seed2" onkeyup="moveToNext(event, 2)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="3" id="seed3" onkeyup="moveToNext(event, 3)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="4" id="seed4" onkeyup="moveToNext(event, 4)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="5" id="seed5" onkeyup="moveToNext(event, 5)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="6" id="seed6" onkeyup="moveToNext(event, 6)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="7" id="seed7" onkeyup="moveToNext(event, 7)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="8" id="seed8" onkeyup="moveToNext(event, 8)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="9" id="seed9" onkeyup="moveToNext(event, 9)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="10" id="seed10" onkeyup="moveToNext(event, 10)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="11" id="seed11" onkeyup="moveToNext(event, 11)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="12" id="seed12" onkeyup="moveToNext(event, 12)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="13" id="seed13" onkeyup="moveToNext(event, 13)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="14" id="seed14" onkeyup="moveToNext(event, 14)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="15" id="seed15" onkeyup="moveToNext(event, 15)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="16" id="seed16" onkeyup="moveToNext(event, 16)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="17" id="seed17" onkeyup="moveToNext(event, 17)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="18" id="seed18" onkeyup="moveToNext(event, 18)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="19" id="seed19" onkeyup="moveToNext(event, 19)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="20" id="seed20" onkeyup="moveToNext(event, 20)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="21" id="seed21" onkeyup="moveToNext(event, 21)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="22" id="seed22" onkeyup="moveToNext(event, 22)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="23" id="seed23" onkeyup="moveToNext(event, 23)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                    <input type="text" class="seed-input" placeholder="24" id="seed24" onkeyup="moveToNext(event, 24)" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(255,255,255,0.05); color: white; text-align: center;">
                </div>
                <button class="button button-secondary" onclick="pasteSeedPhrase()" style="margin-bottom: 15px;">
                    <span>📋</span>
                    <span>Paste from Clipboard</span>
                </button>
            </div>
            
            <div class="input-group">
                <label class="input-label">New Password for QRC Wallet</label>
                <div class="password-toggle">
                    <input type="password" class="input-field" id="importPassword" placeholder="Create password for this device">
                    <button class="password-toggle-btn" onclick="togglePassword('importPassword')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <button class="button button-primary" onclick="importExistingWallet()">
                <span>📥</span>
                <span>Import with Seed Phrase</span>
            </button>
            
            <button class="button button-secondary" onclick="backToLogin()">
                <span>←</span>
                <span>Back to Login</span>
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <header class="main-header">
            <div class="logo-section">
                <div class="logo">QRC</div>
                <div class="logo-text">Quantum Wallet</div>
            </div>
            <div class="user-menu">
                <div class="network-indicator">
                    <div class="network-dot"></div>
                    <span>Mainnet</span>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userDisplay">User</span>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="main-content">
            <div class="stats-section">
                <div class="stat-card">
                    <div class="stat-value" id="currentTPS">0</div>
                    <div class="stat-label">Current TPS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalBlocks">0</div>
                    <div class="stat-label">Total Blocks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTransactions">0</div>
                    <div class="stat-label">Transactions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeUsers">0</div>
                    <div class="stat-label">Active Users</div>
                </div>
            </div>

            <div class="wallet-section">
                <div class="wallet-header">
                    <h2 class="wallet-title">Quantum Resistant Wallet</h2>
                </div>

                <div class="security-status">
                    <span class="security-icon">🔒</span>
                    <span id="securityStatusText">Secured with password + encryption</span>
                </div>

                <div class="algorithm-badge">
                    <div class="badge-icon">✓</div>
                    <span>Protected by CRYSTALS-Dilithium</span>
                </div>

                <div class="wallet-display">
                    <div class="wallet-label">Your Wallet Address</div>
                    <div class="wallet-address-container">
                        <div class="wallet-address" id="walletAddress" onclick="copyAddress()"></div>
                        <div class="address-actions">
                            <button class="menu-button" onclick="showQRModal()" title="Show QR Code">📱</button>
                            <button class="menu-button" onclick="copyAddress()" title="Copy Address">📋</button>
                        </div>
                    </div>
                </div>

                <div class="balance-display">
                    <div class="balance-label">Total Balance</div>
                    <div class="balance-amount" id="balanceAmount">0.00 QRC</div>
                    <div class="balance-usd" id="balanceUSD">≈ $0.00 USD</div>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="showTab('wallet', this)">Wallet</div>
                    <div class="tab" onclick="showTab('activity', this)">Activity</div>
                    <div class="tab" onclick="showTab('security', this)">Security</div>
                </div>

                <div id="walletTab" class="tab-content active">
                    <button class="button button-primary" onclick="showSendModal()">
                        <span>📤</span>
                        <span>Send QRC</span>
                    </button>
                    <button class="button button-secondary" onclick="showReceiveModal()">
                        <span>📥</span>
                        <span>Receive</span>
                    </button>
                    <button class="button button-secondary" onclick="getFaucet()">
                        <span>💧</span>
                        <span>Test Faucet (100 QRC daily)</span>
                    </button>
                </div>

                <div id="activityTab" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">Activity History</h3>
                        <div style="display: flex; gap: 10px;">
                            <select id="activityFilter" class="custom-select" onchange="filterActivity()">
                                <option value="all">All Activities</option>
                                <option value="transaction">Transactions</option>
                                <option value="security">Security</option>
                                <option value="login">Login/Logout</option>
                                <option value="settings">Settings</option>
                            </select>
                            <button class="button button-secondary" onclick="exportActivityLog()" style="width: auto; padding: 8px 16px; margin: 0;">📥 Export</button>
                        </div>
                    </div>
                    <div id="activityHistory" style="max-height: 500px; overflow-y: auto;">
                        <div class="empty-state">
                            <div class="empty-state-icon">📊</div>
                            <p>No activities yet</p>
                            <p style="font-size: 14px; margin-top: 10px;">Your activity history will appear here</p>
                        </div>
                    </div>
                </div>

                <div id="securityTab" class="tab-content">
                    <div style="background: rgba(255, 107, 107, 0.1); border: 1px solid #ff6b6b; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px;">⚠️ Security Information</h4>
                        <p style="font-size: 14px; line-height: 1.6;">Your wallet is encrypted with your password. Never share your seed phrase or password with anyone.</p>
                    </div>
                    
                    <div class="security-grid">
                        <!-- Password Security -->
                        <div class="security-item">
                            <div class="security-item-header">
                                <div class="status-indicator status-enabled"></div>
                                <h3>Password Protection</h3>
                            </div>
                            <p>Change your wallet password</p>
                            <div class="dropdown">
                                <button class="button button-secondary" onclick="toggleDropdown('passwordDropdown')">Manage Password</button>
                                <div id="passwordDropdown" class="dropdown-content">
                                    <div class="dropdown-item" onclick="showChangePassword()">Change Password</div>
                                    <div class="dropdown-item" onclick="showCurrentPassword()">Show Password</div>
                                </div>
                            </div>
                        </div>

                        <!-- Two-Factor Authentication -->
                        <div class="security-item">
                            <div class="security-item-header">
                                <div class="status-indicator status-disabled" id="twoFactorStatus"></div>
                                <h3>Two-Factor Authentication</h3>
                            </div>
                            <p>Add an extra layer of security</p>
                            <div class="dropdown">
                                <button class="button button-secondary" onclick="toggleDropdown('twoFactorDropdown')">Manage 2FA</button>
                                <div id="twoFactorDropdown" class="dropdown-content">
                                    <div class="dropdown-item" onclick="setup2FA()">Setup 2FA</div>
                                    <div class="dropdown-item" onclick="disable2FA()">Disable 2FA</div>
                                    <div class="dropdown-item" onclick="showBackupCodes()">View Backup Codes</div>
                                    <div class="dropdown-item" onclick="regenerateBackupCodes()">Regenerate Codes</div>
                                </div>
                            </div>
                        </div>

                        <!-- Seed Phrase Management -->
                        <div class="security-item">
                            <div class="security-item-header">
                                <div class="status-indicator status-enabled"></div>
                                <h3>Seed Phrase</h3>
                            </div>
                            <p>Backup and manage your recovery phrase</p>
                            <div class="dropdown">
                                <button class="button button-secondary" onclick="toggleDropdown('seedPhraseDropdown')">Manage Seed Phrase</button>
                                <div id="seedPhraseDropdown" class="dropdown-content">
                                    <div class="dropdown-item" onclick="showSeedPhrase()">View Seed Phrase</div>
                                    <div class="dropdown-item" onclick="verifySeedPhrase()">Verify Seed Phrase</div>
                                    <div class="dropdown-item" onclick="exportSeedPhrase()">Export Seed Phrase</div>
                                </div>
                            </div>
                        </div>

                        <!-- Session Management -->
                        <div class="security-item">
                            <div class="security-item-header">
                                <div class="status-indicator status-enabled"></div>
                                <h3>Session Security</h3>
                            </div>
                            <p>Manage active sessions and timeouts</p>
                            <div class="dropdown">
                                <button class="button button-secondary" onclick="toggleDropdown('sessionDropdown')">Manage Sessions</button>
                                <div id="sessionDropdown" class="dropdown-content">
                                    <div class="dropdown-item" onclick="setAutoLock()">Set Auto-Lock Timer</div>
                                    <div class="dropdown-item" onclick="viewActiveSessions()">View Active Sessions</div>
                                    <div class="dropdown-item" onclick="logoutAllDevices()">Logout All Devices</div>
                                </div>
                            </div>
                        </div>

                        <!-- Transaction Limits -->
                        <div class="security-item">
                            <div class="security-item-header">
                                <div class="status-indicator status-disabled"></div>
                                <h3>Transaction Limits</h3>
                            </div>
                            <p>Set daily and per-transaction limits</p>
                            <div class="dropdown">
                                <button class="button button-secondary" onclick="toggleDropdown('limitsDropdown')">Manage Limits</button>
                                <div id="limitsDropdown" class="dropdown-content">
                                    <div class="dropdown-item" onclick="setDailyLimit()">Set Daily Limit</div>
                                    <div class="dropdown-item" onclick="setTransactionLimit()">Set Transaction Limit</div>
                                    <div class="dropdown-item" onclick="enableWhitelist()">Enable Address Whitelist</div>
                                    <div class="dropdown-item" onclick="viewLimitsHistory()">View Limits History</div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Security -->
                        <div class="security-item">
                            <div class="security-item-header">
                                <div class="status-indicator status-enabled"></div>
                                <h3>Advanced Security</h3>
                            </div>
                            <p>Hardware and advanced security features</p>
                            <div class="dropdown">
                                <button class="button button-secondary" onclick="toggleDropdown('advancedDropdown')">Advanced Options</button>
                                <div id="advancedDropdown" class="dropdown-content">
                                    <div class="dropdown-item" onclick="connectHardwareWallet()">Connect Hardware Wallet</div>
                                    <div class="dropdown-item" onclick="setRecoveryContacts()">Set Recovery Contacts</div>
                                    <div class="dropdown-item" onclick="exportPrivateKey()">Export Private Key</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="sendModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Send QRC</h2>
                <button class="close-modal" onclick="closeModal('sendModal')">×</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #999; font-size: 14px;">Recipient Address</label>
                <input type="text" id="recipientAddress" placeholder="QRC..." style="width: 100%; padding: 15px; border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 8px; background: rgba(255, 255, 255, 0.05); color: white; font-size: 16px;">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #999; font-size: 14px;">Amount (QRC)</label>
                <input type="number" id="sendAmount" placeholder="0.00" step="0.01" oninput="updateFeeDisplay()" style="width: 100%; padding: 15px; border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 8px; background: rgba(255, 255, 255, 0.05); color: white; font-size: 16px;">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #999; font-size: 14px;">Transaction Password</label>
                <div class="password-toggle">
                    <input type="password" id="sendPassword" placeholder="Enter your password" style="width: 100%; padding: 15px; border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 8px; background: rgba(255, 255, 255, 0.05); color: white; font-size: 16px;">
                    <button class="password-toggle-btn" onclick="togglePassword('sendPassword')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="input-group" id="transaction2FAField" style="display: none;">
                <label class="input-label">2FA Code (required)</label>
                <input type="text" class="input-field" id="transaction2FA" placeholder="000000" maxlength="6" style="text-align: center;">
            </div>
            
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Network Fee:</span>
                    <span id="feeDisplay">0.00 QRC</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-weight: 600;">
                    <span>Total:</span>
                    <span id="totalDisplay">0.00 QRC</span>
                </div>
            </div>

            <button class="button button-primary" onclick="confirmSend()">
                Sign & Send Transaction
            </button>
        </div>
    </div>

    <div class="modal" id="receiveModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Receive QRC</h2>
                <button class="close-modal" onclick="closeModal('receiveModal')">×</button>
            </div>
            
            <div class="qr-container">
                <h3 class="qr-title">Your QRC Address</h3>
                <div id="receiveQrcode"></div>
                <div class="qr-address" id="receiveAddress"></div>
                <button class="button button-secondary" onclick="copyAddress()">Copy Address</button>
            </div>
        </div>
    </div>

    <div class="modal" id="qrModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">QR Code</h2>
                <button class="close-modal" onclick="closeModal('qrModal')">×</button>
            </div>
            
            <div class="qr-container">
                <h3 class="qr-title">Scan to Send QRC</h3>
                <div id="qrcode"></div>
                <div class="qr-address" id="qrAddress"></div>
                <button class="button button-secondary" onclick="copyAddress()">Copy Address</button>
            </div>
        </div>
    </div>

    <!-- 2FA Setup Modal -->
    <div class="modal" id="twoFactorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🔐 Setup Two-Factor Authentication</h2>
                <button class="close-modal" onclick="closeModal('twoFactorModal')">×</button>
            </div>
            <div class="two-factor-setup">
                <p>Scan this QR code with your authenticator app:</p>
                <div class="qr-code-2fa" id="qrCodeContainer">
                    <!-- QR Code will be generated here -->
                </div>
                <p>Or enter this code manually:</p>
                <div class="manual-code" id="manualCode">
                    <!-- Manual code will be displayed here -->
                </div>
                <div class="input-group">
                    <label class="input-label">Enter 6-digit code from your app:</label>
                    <input type="text" class="input-field" id="twoFactorCode" placeholder="000000" maxlength="6" style="text-align: center;">
                </div>
                <button class="button button-primary" onclick="verify2FA()">Verify & Enable 2FA</button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🔒 Change Password</h2>
                <button class="close-modal" onclick="closeModal('changePasswordModal')">×</button>
            </div>
            <div class="input-group">
                <label class="input-label">Current Password:</label>
                <div class="password-toggle">
                    <input type="password" class="input-field" id="currentPassword" placeholder="Enter current password">
                    <button class="password-toggle-btn" onclick="togglePassword('currentPassword')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">New Password:</label>
                <div class="password-toggle">
                    <input type="password" class="input-field" id="newPasswordChange" placeholder="Enter new password">
                    <button class="password-toggle-btn" onclick="togglePassword('newPasswordChange')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">Confirm New Password:</label>
                <div class="password-toggle">
                    <input type="password" class="input-field" id="confirmPasswordChange" placeholder="Confirm new password">
                    <button class="password-toggle-btn" onclick="togglePassword('confirmPasswordChange')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="input-group" id="passwordChange2FAField" style="display: none;">
                <label class="input-label">2FA Code (required):</label>
                <input type="text" class="input-field" id="passwordChange2FA" placeholder="000000" maxlength="6" style="text-align: center;">
            </div>
            <button class="button button-primary" onclick="changePassword()">Change Password</button>
        </div>
    </div>

    <!-- Backup Codes Modal -->
    <div class="modal" id="backupCodesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🔑 Backup Recovery Codes</h2>
                <button class="close-modal" onclick="closeModal('backupCodesModal')">×</button>
            </div>
            <div style="background: rgba(255, 107, 107, 0.1); border: 1px solid #ff6b6b; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>⚠️ Important:</strong> Save these codes safely. Each code can only be used once.
            </div>
            <div class="backup-codes" id="backupCodesList">
                <!-- Backup codes will be populated here -->
            </div>
            <button class="button button-secondary" onclick="downloadBackupCodes()">💾 Download Codes</button>
            <button class="button button-secondary" onclick="printBackupCodes()">🖨️ Print Codes</button>
        </div>
    </div>

    <!-- Seed Phrase Modal -->
    <div class="modal" id="seedPhraseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🔑 Your Seed Phrase</h2>
                <button class="close-modal" onclick="closeModal('seedPhraseModal')">×</button>
            </div>
            <div style="background: rgba(255, 107, 107, 0.1); border: 1px solid #ff6b6b; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>⚠️ Warning:</strong> Never share your seed phrase with anyone. Store it safely offline.
            </div>
            <div class="input-group">
                <label class="input-label">Enter your password to view seed phrase:</label>
                <div class="password-toggle">
                    <input type="password" class="input-field" id="seedPassword" placeholder="Enter wallet password">
                    <button class="password-toggle-btn" onclick="togglePassword('seedPassword')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="input-group" id="seedPhrase2FAField" style="display: none;">
                <label class="input-label">2FA Code (required):</label>
                <input type="text" class="input-field" id="seedPhrase2FA" placeholder="000000" maxlength="6" style="text-align: center;">
            </div>
            <button class="button button-secondary" onclick="revealSeedPhrase()">Reveal Seed Phrase</button>
            <div id="seedPhraseDisplay" style="display: none; background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin: 20px 0;">
                <div id="seedWordsGrid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0;">
                    <!-- Seed words will be populated here -->
                </div>
                <button class="button button-secondary" onclick="copySeedPhrase()">📋 Copy to Clipboard</button>
                <button class="button button-secondary" onclick="downloadSeedPhrase()">💾 Download Backup</button>
            </div>
        </div>
    </div>

    <!-- Show Password Modal -->
    <div class="modal" id="showPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🔓 Show Current Password</h2>
                <button class="close-modal" onclick="closeModal('showPasswordModal')">×</button>
            </div>
            <div style="background: rgba(255, 107, 107, 0.1); border: 1px solid #ff6b6b; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>⚠️ Security Warning:</strong> Your password will be displayed on screen. Make sure no one is watching.
            </div>
            <div class="input-group" id="showPassword2FAField">
                <label class="input-label">Enter 2FA Code (required):</label>
                <input type="text" class="input-field" id="showPassword2FA" placeholder="000000" maxlength="6" style="text-align: center;">
            </div>
            <button class="button button-primary" onclick="verifyAndShowPassword()">Verify & Show Password</button>
            <div id="passwordDisplay" style="display: none; margin-top: 20px;">
                <label class="input-label">Your Current Password:</label>
                <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 8px; font-family: monospace; font-size: 18px; color: #00ff88; word-break: break-all;">
                    <span id="currentPasswordDisplay"></span>
                </div>
                <button class="button button-secondary" onclick="copyCurrentPassword()" style="margin-top: 15px;">📋 Copy Password</button>
            </div>
        </div>
    </div>

    <!-- Seed Phrase Verification Modal -->
    <div class="modal" id="verifySeedModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">✅ Verify Your Seed Phrase</h2>
                <button class="close-modal" onclick="closeModal('verifySeedModal')">×</button>
            </div>
            <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid #00ff88; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>📝 Verification Test:</strong> Enter the missing words from your seed phrase to confirm you have saved it correctly.
            </div>
            <div id="verificationQuestions" style="margin: 20px 0;">
                <!-- Verification questions will be populated here -->
            </div>
            <button class="button button-primary" onclick="checkSeedVerification()">Verify Seed Phrase</button>
        </div>
    </div>

    <!-- Auto-Lock Modal -->
    <div class="modal" id="autoLockModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">⏰ Set Auto-Lock Timer</h2>
                <button class="close-modal" onclick="closeModal('autoLockModal')">×</button>
            </div>
            <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid #00ff88; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>🔒 Security:</strong> Your wallet will automatically lock after the specified period of inactivity.
            </div>
            <div class="auto-lock-options">
                <div class="lock-option" data-minutes="5" onclick="selectLockOption(this)">
                    <strong>5 minutes</strong>
                    <div style="font-size: 12px; color: #999;">High security</div>
                </div>
                <div class="lock-option" data-minutes="15" onclick="selectLockOption(this)">
                    <strong>15 minutes</strong>
                    <div style="font-size: 12px; color: #999;">Recommended</div>
                </div>
                <div class="lock-option" data-minutes="30" onclick="selectLockOption(this)">
                    <strong>30 minutes</strong>
                    <div style="font-size: 12px; color: #999;">Standard</div>
                </div>
                <div class="lock-option" data-minutes="60" onclick="selectLockOption(this)">
                    <strong>1 hour</strong>
                    <div style="font-size: 12px; color: #999;">Low security</div>
                </div>
                <div class="lock-option" data-minutes="0" onclick="selectLockOption(this)">
                    <strong>Never</strong>
                    <div style="font-size: 12px; color: #999;">Not recommended</div>
                </div>
                <div class="lock-option" data-minutes="custom" onclick="selectLockOption(this)">
                    <strong>Custom</strong>
                    <div style="font-size: 12px; color: #999;">Set your own</div>
                </div>
            </div>
            <div id="customLockTime" style="display: none; margin-top: 20px;">
                <label class="input-label">Custom time (minutes):</label>
                <input type="number" class="input-field" id="customMinutes" placeholder="Enter minutes" min="1" max="1440">
            </div>
            <button class="button button-primary" onclick="saveAutoLock()" style="margin-top: 20px;">Save Auto-Lock Settings</button>
        </div>
    </div>

    <!-- Active Sessions Modal -->
    <div class="modal" id="activeSessionsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">💻 Active Sessions</h2>
                <button class="close-modal" onclick="closeModal('activeSessionsModal')">×</button>
            </div>
            <div id="sessionsList">
                <!-- Sessions will be populated here -->
            </div>
            <button class="button button-secondary" onclick="refreshSessions()" style="margin-top: 20px;">🔄 Refresh</button>
        </div>
    </div>

    <!-- Logout All Devices Modal -->
    <div class="modal" id="logoutAllModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🚪 Logout All Devices</h2>
                <button class="close-modal" onclick="closeModal('logoutAllModal')">×</button>
            </div>
            <div style="background: rgba(255, 107, 107, 0.1); border: 1px solid #ff6b6b; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>⚠️ Warning:</strong> This will log out all other devices and sessions. You will remain logged in on this device only.
            </div>
            <div class="input-group">
                <label class="input-label">Enter Password to Confirm:</label>
                <div class="password-toggle">
                    <input type="password" class="input-field" id="logoutAllPassword" placeholder="Enter your password">
                    <button class="password-toggle-btn" onclick="togglePassword('logoutAllPassword')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="input-group" id="logoutAll2FAField" style="display: none;">
                <label class="input-label">2FA Code (required):</label>
                <input type="text" class="input-field" id="logoutAll2FA" placeholder="000000" maxlength="6" style="text-align: center;">
            </div>
            <div style="margin-top: 20px;">
                <h4 style="margin-bottom: 10px;">Active Sessions to be Terminated:</h4>
                <div id="sessionsToTerminate" style="max-height: 200px; overflow-y: auto;">
                    <!-- Sessions list will be populated here -->
                </div>
            </div>
            <button class="button button-primary" onclick="confirmLogoutAllDevices()" style="margin-top: 20px;">Confirm Logout All Devices</button>
        </div>
    </div>

    <!-- Transaction Limits Modals -->
    <!-- Daily Limit Modal -->
    <div class="modal" id="dailyLimitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">💰 Set Daily Transaction Limit</h2>
                <button class="close-modal" onclick="closeModal('dailyLimitModal')">×</button>
            </div>
            <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid #00ff88; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>🔒 Security:</strong> Limits help protect your funds from unauthorized large transfers.
            </div>
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #00ff88;">Current Daily Limit</h4>
                <div style="font-size: 24px; font-weight: bold; color: #00ff88;" id="currentDailyLimit">No limit set</div>
                <div style="font-size: 14px; color: #999; margin-top: 5px;">Spent today: <span id="dailySpentAmount">0.00 QRC</span></div>
            </div>
            <div class="input-group">
                <label class="input-label">New Daily Limit (QRC)</label>
                <input type="number" class="input-field" id="newDailyLimit" placeholder="0.00" step="0.01" min="0">
                <small style="color: #999; display: block; margin-top: 5px;">Set to 0 to remove limit</small>
            </div>
            <div class="input-group">
                <label class="input-label">Password</label>
                <div class="password-toggle">
                    <input type="password" class="input-field" id="dailyLimitPassword" placeholder="Enter your password">
                    <button class="password-toggle-btn" onclick="togglePassword('dailyLimitPassword')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="input-group" id="dailyLimit2FAField" style="display: none;">
                <label class="input-label">2FA Code</label>
                <input type="text" class="input-field" id="dailyLimit2FA" placeholder="000000" maxlength="6" style="text-align: center;">
            </div>
            <button class="button button-primary" onclick="saveDailyLimit()">Set Daily Limit</button>
        </div>
    </div>

    <!-- Transaction Limit Modal -->
    <div class="modal" id="transactionLimitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">💸 Set Per-Transaction Limit</h2>
                <button class="close-modal" onclick="closeModal('transactionLimitModal')">×</button>
            </div>
            <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid #00ff88; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>🔒 Security:</strong> Prevent any single transaction from exceeding this amount.
            </div>
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #00ff88;">Current Transaction Limit</h4>
                <div style="font-size: 24px; font-weight: bold; color: #00ff88;" id="currentTransactionLimit">No limit set</div>
            </div>
            <div class="input-group">
                <label class="input-label">Maximum per Transaction (QRC)</label>
                <input type="number" class="input-field" id="newTransactionLimit" placeholder="0.00" step="0.01" min="0">
                <small style="color: #999; display: block; margin-top: 5px;">Set to 0 to remove limit</small>
            </div>
            <div class="input-group">
                <label class="input-label">Password</label>
                <div class="password-toggle">
                    <input type="password" class="input-field" id="transactionLimitPassword" placeholder="Enter your password">
                    <button class="password-toggle-btn" onclick="togglePassword('transactionLimitPassword')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="input-group" id="transactionLimit2FAField" style="display: none;">
                <label class="input-label">2FA Code</label>
                <input type="text" class="input-field" id="transactionLimit2FA" placeholder="000000" maxlength="6" style="text-align: center;">
            </div>
            <button class="button button-primary" onclick="saveTransactionLimit()">Set Transaction Limit</button>
        </div>
    </div>

    <!-- Whitelist Modal -->
    <div class="modal" id="whitelistModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">📋 Address Whitelist</h2>
                <button class="close-modal" onclick="closeModal('whitelistModal')">×</button>
            </div>
            <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid #00ff88; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>ℹ️ Info:</strong> Only whitelisted addresses can receive funds when this feature is enabled.
            </div>
            
            <!-- Whitelist Status Toggle -->
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4 style="margin: 0; color: #fff;">Whitelist Status</h4>
                        <p style="margin: 5px 0 0 0; color: #999; font-size: 14px;">
                            <span id="whitelistStatusText">Currently disabled</span>
                        </p>
                    </div>
                    <button class="button button-secondary" id="whitelistToggle" onclick="showToggleWhitelistModal()" style="width: auto; margin: 0;">
                        <span id="whitelistToggleText">Enable</span>
                    </button>
                </div>
            </div>
            
            <!-- Add Address Section -->
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 15px 0;">Add Address to Whitelist</h4>
                <div class="input-group">
                    <label class="input-label">Wallet Address</label>
                    <input type="text" class="input-field" id="whitelistAddress" placeholder="QRC...">
                </div>
                <div class="input-group">
                    <label class="input-label">Label (optional)</label>
                    <input type="text" class="input-field" id="whitelistLabel" placeholder="e.g., Exchange Wallet">
                </div>
                <button class="button button-secondary" onclick="showAddToWhitelistModal()">Add Address</button>
            </div>
            
            <!-- Whitelisted Addresses -->
            <div>
                <h4 style="margin-bottom: 15px;">Whitelisted Addresses</h4>
                <div id="whitelistAddresses" style="max-height: 300px; overflow-y: auto;">
                    <p style="color: #999;">No addresses whitelisted yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toggle Whitelist Modal -->
    <div class="modal" id="toggleWhitelistModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="toggleWhitelistTitle">Enable Address Whitelist</h2>
                <button class="close-modal" onclick="closeModal('toggleWhitelistModal')">×</button>
            </div>
            <div style="background: rgba(255, 107, 107, 0.1); border: 1px solid #ff6b6b; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>⚠️ Warning:</strong> <span id="toggleWhitelistWarning">Enabling whitelist will restrict transfers to only approved addresses.</span>
            </div>
            <div class="input-group">
                <label class="input-label">Password</label>
                <div class="password-toggle">
                    <input type="password" class="input-field" id="toggleWhitelistPassword" placeholder="Enter your password">
                    <button class="password-toggle-btn" onclick="togglePassword('toggleWhitelistPassword')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="input-group" id="toggleWhitelist2FAField" style="display: none;">
                <label class="input-label">2FA Code</label>
                <input type="text" class="input-field" id="toggleWhitelist2FA" placeholder="000000" maxlength="6" style="text-align: center;">
            </div>
            <button class="button button-primary" onclick="confirmToggleWhitelist()">Confirm</button>
        </div>
    </div>

    <!-- Add to Whitelist Modal -->
    <div class="modal" id="addToWhitelistModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">➕ Add Address to Whitelist</h2>
                <button class="close-modal" onclick="closeModal('addToWhitelistModal')">×</button>
            </div>
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <div style="margin-bottom: 10px;">
                    <strong>Address:</strong> <span id="confirmWhitelistAddress" style="font-family: monospace; color: #00ff88;"></span>
                </div>
                <div>
                    <strong>Label:</strong> <span id="confirmWhitelistLabel" style="color: #00ff88;"></span>
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">Password</label>
                <div class="password-toggle">
                    <input type="password" class="input-field" id="addWhitelistPassword" placeholder="Enter your password">
                    <button class="password-toggle-btn" onclick="togglePassword('addWhitelistPassword')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="input-group" id="addWhitelist2FAField" style="display: none;">
                <label class="input-label">2FA Code</label>
                <input type="text" class="input-field" id="addWhitelist2FA" placeholder="000000" maxlength="6" style="text-align: center;">
            </div>
            <button class="button button-primary" onclick="confirmAddToWhitelist()">Add to Whitelist</button>
        </div>
    </div>

    <!-- Limits History Modal -->
    <div class="modal" id="limitsHistoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">📊 Transaction Limits History</h2>
                <button class="close-modal" onclick="closeModal('limitsHistoryModal')">×</button>
            </div>
            <div id="limitsHistoryContent" style="max-height: 400px; overflow-y: auto;">
                <!-- History will be populated here -->
            </div>
            <button class="button button-secondary" onclick="closeModal('limitsHistoryModal')" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Advanced Security Modals -->
    <!-- Hardware Wallet Modal -->
    <div class="modal" id="hardwareWalletModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🔐 Connect Hardware Wallet</h2>
                <button class="close-modal" onclick="closeModal('hardwareWalletModal')">×</button>
            </div>
            <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid #00ff88; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>🛡️ Enhanced Security:</strong> Hardware wallets provide the highest level of security by keeping your private keys offline.
            </div>
            
            <!-- Wallet Selection -->
            <div style="margin-bottom: 20px;">
                <h4 style="margin-bottom: 15px;">Select Your Hardware Wallet</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <button class="wallet-connect-btn" onclick="selectHardwareWallet('ledger')" id="ledgerBtn">
                        <img src="data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='%23000000'%3E%3Cpath d='M4 4h7v7H4zm9 0h7v7h-7zm0 9h7v7h-7zm-9 0h7v7H4z'/%3E%3C/svg%3E" alt="Ledger">
                        <span>Ledger</span>
                    </button>
                    <button class="wallet-connect-btn" onclick="selectHardwareWallet('trezor')" id="trezorBtn">
                        <img src="data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='%23000000'%3E%3Cpath d='M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z'/%3E%3C/svg%3E" alt="Trezor">
                        <span>Trezor</span>
                    </button>
                </div>
            </div>
            
            <!-- Connection Status -->
            <div id="hardwareConnectionStatus" style="display: none; background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0;">Connection Status</h4>
                <div id="connectionStatusText" style="color: #999;">Waiting for device...</div>
                <div id="connectionProgress" style="margin-top: 10px;"></div>
            </div>
            
            <!-- Security Verification -->
            <div id="hardwareSecurityVerification" style="display: none;">
                <div class="input-group">
                    <label class="input-label">Password</label>
                    <div class="password-toggle">
                        <input type="password" class="input-field" id="hardwarePassword" placeholder="Enter your password">
                        <button class="password-toggle-btn" onclick="togglePassword('hardwarePassword')">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="input-group" id="hardware2FAField" style="display: none;">
                    <label class="input-label">2FA Code</label>
                    <input type="text" class="input-field" id="hardware2FA" placeholder="000000" maxlength="6" style="text-align: center;">
                </div>
                <button class="button button-primary" onclick="confirmHardwareConnection()">Connect Hardware Wallet</button>
            </div>
        </div>
    </div>

    <!-- Recovery Contacts Modal -->
    <div class="modal" id="recoveryContactsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">👥 Recovery Contacts</h2>
                <button class="close-modal" onclick="closeModal('recoveryContactsModal')">×</button>
            </div>
            <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid #00ff88; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>🔄 Recovery System:</strong> Set trusted contacts who can help recover your wallet in case of emergency.
            </div>
            
            <!-- Current Recovery Contacts -->
            <div style="margin-bottom: 20px;">
                <h4 style="margin-bottom: 15px;">Current Recovery Contacts</h4>
                <div id="recoveryContactsList">
                    <p style="color: #999;">No recovery contacts set</p>
                </div>
            </div>
            
            <!-- Add Recovery Contact -->
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px;">
                <h4 style="margin: 0 0 15px 0;">Add Recovery Contact</h4>
                <div class="input-group">
                    <label class="input-label">Contact Name</label>
                    <input type="text" class="input-field" id="recoveryContactName" placeholder="e.g., John Doe">
                </div>
                <div class="input-group">
                    <label class="input-label">Contact Email</label>
                    <input type="email" class="input-field" id="recoveryContactEmail" placeholder="email@example.com">
                </div>
                <div class="input-group">
                    <label class="input-label">Contact Wallet Address (optional)</label>
                    <input type="text" class="input-field" id="recoveryContactAddress" placeholder="QRC...">
                </div>
                <div class="input-group">
                    <label class="input-label">Recovery Threshold</label>
                    <select class="input-field custom-select" id="recoveryThreshold" style="width: 100%;">
                        <option value="1">1 contact required</option>
                        <option value="2" selected>2 contacts required</option>
                        <option value="3">3 contacts required</option>
                    </select>
                </div>
                <button class="button button-secondary" onclick="showAddRecoveryContactModal()">Add Contact</button>
            </div>
        </div>
    </div>

    <!-- Add Recovery Contact Confirmation Modal -->
    <div class="modal" id="addRecoveryContactModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">➕ Add Recovery Contact</h2>
                <button class="close-modal" onclick="closeModal('addRecoveryContactModal')">×</button>
            </div>
            <div style="background: rgba(255, 107, 107, 0.1); border: 1px solid #ff6b6b; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>⚠️ Important:</strong> Recovery contacts can initiate wallet recovery. Only add highly trusted individuals.
            </div>
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <div style="margin-bottom: 10px;">
                    <strong>Name:</strong> <span id="confirmRecoveryName" style="color: #00ff88;"></span>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Email:</strong> <span id="confirmRecoveryEmail" style="color: #00ff88;"></span>
                </div>
                <div id="confirmRecoveryAddressDiv" style="margin-bottom: 10px;">
                    <strong>Wallet:</strong> <span id="confirmRecoveryAddress" style="color: #00ff88; font-family: monospace;"></span>
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">Password</label>
                <div class="password-toggle">
                    <input type="password" class="input-field" id="addRecoveryPassword" placeholder="Enter your password">
                    <button class="password-toggle-btn" onclick="togglePassword('addRecoveryPassword')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="input-group" id="addRecovery2FAField" style="display: none;">
                <label class="input-label">2FA Code</label>
                <input type="text" class="input-field" id="addRecovery2FA" placeholder="000000" maxlength="6" style="text-align: center;">
            </div>
            <button class="button button-primary" onclick="confirmAddRecoveryContact()">Add Recovery Contact</button>
        </div>
    </div>

    <!-- Export Private Key Modal -->
    <div class="modal" id="exportPrivateKeyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🔑 Export Private Key</h2>
                <button class="close-modal" onclick="closeModal('exportPrivateKeyModal')">×</button>
            </div>
            <div style="background: rgba(255, 107, 107, 0.1); border: 1px solid #ff6b6b; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>⚠️ EXTREME CAUTION:</strong> Your private key provides complete access to your wallet. Never share it with anyone. Store it offline in a secure location.
            </div>
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 15px 0;">Security Checklist</h4>
                <div style="margin-bottom: 10px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="privateKeyCheck1" style="width: 20px; height: 20px;">
                        <span>I understand that anyone with my private key can access my funds</span>
                    </label>
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="privateKeyCheck2" style="width: 20px; height: 20px;">
                        <span>I am in a secure location with no one watching</span>
                    </label>
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="privateKeyCheck3" style="width: 20px; height: 20px;">
                        <span>I will store this key offline in a secure location</span>
                    </label>
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">Password</label>
                <div class="password-toggle">
                    <input type="password" class="input-field" id="exportPrivateKeyPassword" placeholder="Enter your password">
                    <button class="password-toggle-btn" onclick="togglePassword('exportPrivateKeyPassword')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="input-group" id="exportPrivateKey2FAField" style="display: none;">
                <label class="input-label">2FA Code</label>
                <input type="text" class="input-field" id="exportPrivateKey2FA" placeholder="000000" maxlength="6" style="text-align: center;">
            </div>
            <button class="button button-primary" onclick="revealPrivateKey()" id="revealPrivateKeyBtn">Reveal Private Key</button>
            
            <!-- Private Key Display -->
            <div id="privateKeyDisplay" style="display: none; margin-top: 20px;">
                <div style="background: rgba(255, 0, 0, 0.1); border: 2px solid #ff0000; padding: 20px; border-radius: 12px;">
                    <h4 style="margin: 0 0 15px 0; color: #ff6b6b;">⚠️ Your Private Key</h4>
                    <div style="background: #000; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <code id="privateKeyValue" style="font-family: monospace; font-size: 14px; word-break: break-all; color: #00ff88;"></code>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="button button-secondary" onclick="copyPrivateKey()">📋 Copy</button>
                        <button class="button button-secondary" onclick="downloadPrivateKey()">💾 Download</button>
                        <button class="button button-secondary" onclick="hidePrivateKey()" style="background: rgba(255, 107, 107, 0.1); border-color: #ff6b6b; color: #ff6b6b;">🔒 Hide</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // Global state
        let walletState = {
            address: null,
            seedPhrase: null,
            balance: 0,
            encryptedData: null,
            isLoggedIn: false,
            transactions: [],
            twoFactorSecret: null,
            twoFactorEnabled: false,
            sessions: [],
            autoLockMinutes: 15,
            currentSessionId: null,
            activityLog: []
        };
        
        let sessionPassword = null;
        let qrcode = null;
        let receiveQrcode = null;
        let activityInterval = null;
        let balanceInterval = null;
        let autoLockTimeout = null;
        let lastActivityTime = Date.now();

        // Initialize session management
        function initializeSessionManagement() {
            if (!walletState.sessions) {
                walletState.sessions = [];
            }
            if (!walletState.autoLockMinutes) {
                walletState.autoLockMinutes = 15;
            }
            
            // Generate session ID
            walletState.currentSessionId = generateSessionId();
            
            // Add current session
            const sessionInfo = {
                id: walletState.currentSessionId,
                device: getDeviceInfo(),
                browser: getBrowserInfo(),
                ip: 'Current Device',
                loginTime: Date.now(),
                lastActivity: Date.now(),
                current: true
            };
            
            walletState.sessions.push(sessionInfo);
            
            // Clean old sessions (older than 30 days)
            const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
            walletState.sessions = walletState.sessions.filter(session => 
                session.loginTime > thirtyDaysAgo || session.current
            );
            
            // Start auto-lock timer
            resetAutoLockTimer();
            
            // Track user activity
            document.addEventListener('mousemove', resetAutoLockTimer);
            document.addEventListener('keypress', resetAutoLockTimer);
            document.addEventListener('click', resetAutoLockTimer);
        }

        function generateSessionId() {
            return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function getDeviceInfo() {
            const userAgent = navigator.userAgent;
            if (/mobile/i.test(userAgent)) {
                if (/android/i.test(userAgent)) return 'Android Device';
                if (/iphone|ipad|ipod/i.test(userAgent)) return 'iOS Device';
                return 'Mobile Device';
            }
            if (/tablet/i.test(userAgent)) return 'Tablet';
            if (/macintosh/i.test(userAgent)) return 'Mac';
            if (/windows/i.test(userAgent)) return 'Windows PC';
            if (/linux/i.test(userAgent)) return 'Linux PC';
            return 'Unknown Device';
        }

        function getBrowserInfo() {
            const userAgent = navigator.userAgent;
            if (/chrome/i.test(userAgent) && !/edg/i.test(userAgent)) return 'Chrome';
            if (/safari/i.test(userAgent) && !/chrome/i.test(userAgent)) return 'Safari';
            if (/firefox/i.test(userAgent)) return 'Firefox';
            if (/edg/i.test(userAgent)) return 'Edge';
            if (/opera|opr/i.test(userAgent)) return 'Opera';
            return 'Unknown Browser';
        }

        function resetAutoLockTimer() {
            lastActivityTime = Date.now();
            
            if (autoLockTimeout) {
                clearTimeout(autoLockTimeout);
            }
            
            if (walletState.autoLockMinutes > 0) {
                autoLockTimeout = setTimeout(() => {
                    autoLockWallet();
                }, walletState.autoLockMinutes * 60 * 1000);
            }
        }

        function autoLockWallet() {
            if (walletState.isLoggedIn) {
                showNotification('Wallet locked due to inactivity', 'warning');
                logout(true); // Pass true to indicate auto-lock
            }
        }

        // Session Security Functions
        function setAutoLock() {
            // Load current setting
            const currentMinutes = walletState.autoLockMinutes || 15;
            
            // Select current option
            const options = document.querySelectorAll('.lock-option');
            options.forEach(option => {
                option.classList.remove('selected');
                const minutes = parseInt(option.dataset.minutes);
                if (minutes === currentMinutes || (currentMinutes > 60 && option.dataset.minutes === 'custom')) {
                    option.classList.add('selected');
                    if (option.dataset.minutes === 'custom') {
                        document.getElementById('customLockTime').style.display = 'block';
                        document.getElementById('customMinutes').value = currentMinutes;
                    }
                }
            });
            
            document.getElementById('autoLockModal').style.display = 'flex';
        }

        function selectLockOption(element) {
            // Remove previous selection
            document.querySelectorAll('.lock-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            
            // Show/hide custom input
            if (element.dataset.minutes === 'custom') {
                document.getElementById('customLockTime').style.display = 'block';
            } else {
                document.getElementById('customLockTime').style.display = 'none';
            }
        }

        function saveAutoLock() {
            const selected = document.querySelector('.lock-option.selected');
            if (!selected) {
                showNotification('Please select an auto-lock option', 'error');
                return;
            }
            
            let minutes = parseInt(selected.dataset.minutes);
            
            if (selected.dataset.minutes === 'custom') {
                minutes = parseInt(document.getElementById('customMinutes').value);
                if (!minutes || minutes < 1 || minutes > 1440) {
                    showNotification('Please enter a valid time between 1 and 1440 minutes', 'error');
                    return;
                }
            }
            
            walletState.autoLockMinutes = minutes;
            
            // Log activity
            logActivity('settings', 'Auto-lock Changed', {
                message: minutes === 0 ? 'Auto-lock disabled' : `Auto-lock set to ${minutes} minutes`
            });
            
            // Save state
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
            localStorage.setItem('qrcWalletEncrypted', encrypted);
            
            // Reset timer with new value
            resetAutoLockTimer();
            
            closeModal('autoLockModal');
            showNotification(minutes === 0 ? 'Auto-lock disabled' : `Auto-lock set to ${minutes} minutes`, 'success');
        }

        function viewActiveSessions() {
            updateSessionsList();
            document.getElementById('activeSessionsModal').style.display = 'flex';
        }

        function updateSessionsList() {
            const sessionsList = document.getElementById('sessionsList');
            
            if (!walletState.sessions || walletState.sessions.length === 0) {
                sessionsList.innerHTML = '<p style="color: #999; text-align: center;">No active sessions found</p>';
                return;
            }
            
            sessionsList.innerHTML = walletState.sessions
                .sort((a, b) => b.loginTime - a.loginTime)
                .map(session => {
                    const isCurrent = session.id === walletState.currentSessionId;
                    const loginTime = new Date(session.loginTime).toLocaleString();
                    const lastActivity = new Date(session.lastActivity).toLocaleString();
                    
                    return `
                        <div class="session-item ${isCurrent ? 'session-current' : ''}">
                            <div class="session-info">
                                <div class="session-device">
                                    ${session.device} - ${session.browser}
                                    ${isCurrent ? '<span style="color: #00ff88; margin-left: 10px;">(Current)</span>' : ''}
                                </div>
                                <div class="session-details">
                                    IP: ${session.ip}
                                </div>
                                <div class="session-time">
                                    Login: ${loginTime}
                                </div>
                                <div class="session-time">
                                    Last active: ${lastActivity}
                                </div>
                            </div>
                            ${!isCurrent ? `<button class="remove-btn" onclick="terminateSession('${session.id}')">Terminate</button>` : ''}
                        </div>
                    `;
                })
                .join('');
        }

        function terminateSession(sessionId) {
            walletState.sessions = walletState.sessions.filter(session => session.id !== sessionId);
            
            // Save state
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
            localStorage.setItem('qrcWalletEncrypted', encrypted);
            
            updateSessionsList();
            showNotification('Session terminated', 'success');
        }

        function refreshSessions() {
            // Update last activity for current session
            const currentSession = walletState.sessions.find(s => s.id === walletState.currentSessionId);
            if (currentSession) {
                currentSession.lastActivity = Date.now();
            }
            
            updateSessionsList();
            showNotification('Sessions refreshed', 'success');
        }

        function logoutAllDevices() {
            // Show list of sessions that will be terminated
            const sessionsToTerminate = walletState.sessions.filter(session => 
                session.id !== walletState.currentSessionId
            );
            
            const sessionsList = document.getElementById('sessionsToTerminate');
            
            if (sessionsToTerminate.length === 0) {
                sessionsList.innerHTML = '<p style="color: #999;">No other active sessions found</p>';
            } else {
                sessionsList.innerHTML = sessionsToTerminate.map(session => {
                    const loginTime = new Date(session.loginTime).toLocaleString();
                    return `
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                            <div style="font-weight: 600;">${session.device} - ${session.browser}</div>
                            <div style="font-size: 12px; color: #999;">Login: ${loginTime}</div>
                        </div>
                    `;
                }).join('');
            }
            
            // Show/hide 2FA field based on 2FA status
            if (walletState.twoFactorEnabled) {
                document.getElementById('logoutAll2FAField').style.display = 'block';
            } else {
                document.getElementById('logoutAll2FAField').style.display = 'none';
            }
            
            // Clear form fields
            document.getElementById('logoutAllPassword').value = '';
            document.getElementById('logoutAll2FA').value = '';
            
            document.getElementById('logoutAllModal').style.display = 'flex';
        }
        
        function confirmLogoutAllDevices() {
            const password = document.getElementById('logoutAllPassword').value;
            const twoFactorCode = document.getElementById('logoutAll2FA').value;
            
            if (!password) {
                showNotification('Please enter your password', 'error');
                return;
            }
            
            if (password !== sessionPassword) {
                showNotification('Incorrect password', 'error');
                return;
            }
            
            // Check 2FA if enabled
            if (walletState.twoFactorEnabled) {
                if (!twoFactorCode) {
                    showNotification('2FA code is required', 'error');
                    return;
                }
                if (!verifyTOTP(walletState.twoFactorSecret, twoFactorCode)) {
                    showNotification('Invalid 2FA code', 'error');
                    return;
                }
            }
            
            // Clear all sessions except current
            const terminatedCount = walletState.sessions.filter(session => 
                session.id !== walletState.currentSessionId
            ).length;
            
            walletState.sessions = walletState.sessions.filter(session => 
                session.id === walletState.currentSessionId
            );
            
            // Generate new session token (invalidates other sessions)
            walletState.sessionToken = generateSessionId();
            
            // Log activity
            logActivity('security', 'All Devices Logged Out', {
                message: `${terminatedCount} device${terminatedCount > 1 ? 's' : ''} logged out`
            });
            
            // Save state
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
            localStorage.setItem('qrcWalletEncrypted', encrypted);
            
            closeModal('logoutAllModal');
            
            if (terminatedCount > 0) {
                showNotification(`Successfully logged out ${terminatedCount} other device${terminatedCount > 1 ? 's' : ''}`, 'success');
            } else {
                showNotification('No other active sessions to terminate', 'info');
            }
            
            // Clear form
            document.getElementById('logoutAllPassword').value = '';
            document.getElementById('logoutAll2FA').value = '';
        }

        // Remove biometric function
        function enableBiometric() {
            // Function removed as requested
        }

        // TOTP Implementation
        function base32tohex(base32) {
            const base32chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
            let bits = "";
            let hex = "";
            
            for (let i = 0; i < base32.length; i++) {
                const val = base32chars.indexOf(base32.charAt(i).toUpperCase());
                if (val === -1) continue;
                bits += val.toString(2).padStart(5, '0');
            }
            
            for (let i = 0; i + 4 <= bits.length; i += 4) {
                const chunk = bits.substr(i, 4);
                hex = hex + parseInt(chunk, 2).toString(16);
            }
            return hex;
        }

        function generateHOTP(secret, counter) {
            const key = CryptoJS.enc.Hex.parse(base32tohex(secret));
            const counterBytes = CryptoJS.enc.Hex.parse(counter.toString(16).padStart(16, '0'));
            const hmac = CryptoJS.HmacSHA1(counterBytes, key);
            const offset = parseInt(hmac.toString().substr(-1), 16);
            const binary = parseInt(hmac.toString().substr(offset * 2, 8), 16) & 0x7fffffff;
            return binary.toString().substr(-6).padStart(6, '0');
        }

        function generateTOTP(secret, window = 0) {
            const counter = Math.floor(Date.now() / 30000) + window;
            return generateHOTP(secret, counter);
        }

        function verifyTOTP(secret, token) {
            // Check current and adjacent windows
            for (let i = -1; i <= 1; i++) {
                if (generateTOTP(secret, i) === token) {
                    return true;
                }
            }
            return false;
        }

        // Utility functions
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        function togglePassword(fieldId) {
            const input = document.getElementById(fieldId);
            const toggle = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                toggle.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>';
            } else {
                input.type = 'password';
                toggle.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>';
            }
        }

        function showError(message) {
            document.getElementById('loginError').textContent = message;
            document.getElementById('loginError').style.display = 'block';
            setTimeout(() => {
                document.getElementById('loginError').style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            document.getElementById('loginSuccess').textContent = message;
            document.getElementById('loginSuccess').style.display = 'block';
            setTimeout(() => {
                document.getElementById('loginSuccess').style.display = 'none';
            }, 5000);
        }

        // Dropdown Management
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.classList.toggle('show');
            
            // Close other dropdowns
            const allDropdowns = document.querySelectorAll('.dropdown-content');
            allDropdowns.forEach(dd => {
                if (dd.id !== dropdownId) {
                    dd.classList.remove('show');
                }
            });
        }

        // Close dropdowns when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.button') && !event.target.matches('.dropdown-item')) {
                const dropdowns = document.querySelectorAll('.dropdown-content');
                dropdowns.forEach(dropdown => {
                    if (dropdown.classList.contains('show')) {
                        dropdown.classList.remove('show');
                    }
                });
            }
        }

        // Modal Management
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Login functions
        function attemptLogin() {
            const password = document.getElementById('walletPassword').value;
            const twoFactorCode = document.getElementById('login2FA').value;
            
            if (!password) {
                showError('Please enter your password');
                return;
            }
            
            const encryptedWallet = localStorage.getItem('qrcWalletEncrypted');
            if (!encryptedWallet) {
                showError('No wallet found. Please create a new wallet.');
                return;
            }
            
            try {
                // Decrypt wallet data
                const decrypted = CryptoJS.AES.decrypt(encryptedWallet, password);
                const decryptedStr = decrypted.toString(CryptoJS.enc.Utf8);
                
                if (!decryptedStr) {
                    showError('Invalid password');
                    return;
                }
                
                walletState = JSON.parse(decryptedStr);
                
                // Check if 2FA is enabled
                if (walletState.twoFactorEnabled) {
                    if (!document.getElementById('login2FAField').style.display || document.getElementById('login2FAField').style.display === 'none') {
                        document.getElementById('login2FAField').style.display = 'block';
                        showError('Please enter your 2FA code');
                        return;
                    }
                    
                    if (!twoFactorCode) {
                        showError('Please enter your 2FA code');
                        return;
                    }
                    
                    if (!verifyTOTP(walletState.twoFactorSecret, twoFactorCode)) {
                        showError('Invalid 2FA code');
                        return;
                    }
                }
                
                walletState.isLoggedIn = true;
                sessionPassword = password;
                
                // Initialize session management
                initializeSessionManagement();
                
                // Log login activity
                logActivity('login', 'Login', {
                    device: getDeviceInfo() + ' - ' + getBrowserInfo(),
                    ip: 'Current Device'
                });
                
                // Show main app
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                
                // Initialize app
                initializeApp();
                showNotification('Welcome back! Wallet unlocked successfully', 'success');
                
            } catch (error) {
                showError('Invalid password or corrupted wallet data');
            }
        }

        function showCreateNewWallet() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('createWalletForm').style.display = 'block';
        }

        function showImportWallet() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('importWalletForm').style.display = 'block';
        }

        function backToLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('createWalletForm').style.display = 'none';
            document.getElementById('importWalletForm').style.display = 'none';
            document.getElementById('login2FAField').style.display = 'none';
            document.getElementById('login2FA').value = '';
        }

        function createNewWallet() {
            const password = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;
            
            if (password.length < 8) {
                showError('Password must be at least 8 characters');
                return;
            }
            
            if (password !== confirmPass) {
                showError('Passwords do not match');
                return;
            }
            
            // Generate seed phrase
            const seedPhrase = generateSeedPhrase();
            
            // Create wallet
            walletState = {
                address: 'QRC' + generateRandomString(32),
                seedPhrase: seedPhrase,
                balance: 1000,
                transactions: [],
                created: Date.now(),
                twoFactorEnabled: false,
                twoFactorSecret: null,
                sessions: [],
                autoLockMinutes: 15
            };
            
            // Encrypt and save
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), password).toString();
            localStorage.setItem('qrcWalletEncrypted', encrypted);
            
            showSuccess('Wallet created successfully! Please login.');
            setTimeout(() => {
                backToLogin();
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            }, 2000);
        }

        function importExistingWallet() {
            // Collect seed phrase from individual inputs
            const seedWords = [];
            for (let i = 1; i <= 24; i++) {
                const word = document.getElementById(`seed${i}`).value.trim().toLowerCase();
                if (!word) {
                    showError(`Please enter word ${i} of your seed phrase`);
                    document.getElementById(`seed${i}`).focus();
                    return;
                }
                seedWords.push(word);
            }
            
            const seedPhrase = seedWords.join(' ');
            const password = document.getElementById('importPassword').value;
            
            if (password.length < 8) {
                showError('Password must be at least 8 characters');
                return;
            }
            
            // Import wallet
            walletState = {
                address: 'QRC' + generateAddressFromSeed(seedPhrase),
                seedPhrase: seedWords,
                balance: 0,
                transactions: [],
                imported: Date.now(),
                twoFactorEnabled: false,
                twoFactorSecret: null,
                sessions: [],
                autoLockMinutes: 15
            };
            
            // Encrypt and save
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), password).toString();
            localStorage.setItem('qrcWalletEncrypted', encrypted);
            
            showSuccess('Wallet imported successfully! Please login.');
            setTimeout(() => {
                backToLogin();
                // Clear all seed inputs
                for (let i = 1; i <= 24; i++) {
                    document.getElementById(`seed${i}`).value = '';
                }
                document.getElementById('importPassword').value = '';
            }, 2000);
        }
        
        // Helper functions for seed phrase input
        function moveToNext(event, currentIndex) {
            const input = event.target;
            
            // Move to next on space or when word looks complete
            if (event.key === ' ' || (input.value.length > 2 && event.key !== 'Backspace')) {
                if (currentIndex < 24) {
                    document.getElementById(`seed${currentIndex + 1}`).focus();
                }
            }
            
            // Move to previous on backspace when empty
            if (event.key === 'Backspace' && input.value === '' && currentIndex > 1) {
                document.getElementById(`seed${currentIndex - 1}`).focus();
            }
        }
        
        async function pasteSeedPhrase() {
            try {
                const text = await navigator.clipboard.readText();
                const words = text.trim().split(/\s+/);
                
                if (words.length !== 24) {
                    showError('Clipboard must contain exactly 24 words');
                    return;
                }
                
                // Fill in the seed phrase inputs
                words.forEach((word, index) => {
                    const input = document.getElementById(`seed${index + 1}`);
                    if (input) {
                        input.value = word.toLowerCase();
                    }
                });
                
                showNotification('Seed phrase pasted successfully', 'success');
            } catch (error) {
                showError('Failed to read clipboard. Please paste manually.');
            }
        }

        function logout(isAutoLock = false) {
            if (!isAutoLock) {
                // Use notification instead of confirm popup
                showNotification('Click logout again within 3 seconds to confirm', 'warning');
                
                // Set a timeout to actually logout if clicked again
                if (window.logoutTimeout) {
                    clearTimeout(window.logoutTimeout);
                    performLogout();
                } else {
                    window.logoutTimeout = setTimeout(() => {
                        window.logoutTimeout = null;
                    }, 3000);
                }
            } else {
                performLogout();
            }
        }
        
        function performLogout() {
            // Log logout activity before clearing
            logActivity('login', 'Logout', {
                device: getDeviceInfo() + ' - ' + getBrowserInfo()
            });
            
            // Update session end time
            const currentSession = walletState.sessions.find(s => s.id === walletState.currentSessionId);
            if (currentSession) {
                currentSession.current = false;
                currentSession.logoutTime = Date.now();
            }
            
            // Save state before logout
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
            localStorage.setItem('qrcWalletEncrypted', encrypted);
            
            walletState = {
                address: null,
                seedPhrase: null,
                balance: 0,
                isLoggedIn: false,
                transactions: []
            };
            sessionPassword = null;
            
            // Clear intervals
            if (activityInterval) clearInterval(activityInterval);
            if (balanceInterval) clearInterval(balanceInterval);
            if (autoLockTimeout) clearTimeout(autoLockTimeout);
            
            // Remove event listeners
            document.removeEventListener('mousemove', resetAutoLockTimer);
            document.removeEventListener('keypress', resetAutoLockTimer);
            document.removeEventListener('click', resetAutoLockTimer);
            
            // Show login screen
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('walletPassword').value = '';
            
            showNotification('Logged out successfully', 'info');
            window.logoutTimeout = null;
        }

        // App initialization
        function initializeApp() {
            // Update UI with wallet info
            document.getElementById('walletAddress').textContent = walletState.address;
            document.getElementById('userAvatar').textContent = walletState.address.substring(3, 4).toUpperCase();
            document.getElementById('userDisplay').textContent = walletState.address.substring(0, 8) + '...';
            
            // Update 2FA status
            if (walletState.twoFactorEnabled) {
                document.getElementById('twoFactorStatus').className = 'status-indicator status-enabled';
                document.getElementById('securityStatusText').textContent = 'Secured with password + 2FA + encryption';
            }
            
            // Update balance
            updateBalanceDisplay();
            
            // Start real-time updates
            startRealtimeUpdates();
            
            // Load initial data
            updateStats();
            loadTransactionHistory();
        }

        function startRealtimeUpdates() {
            // Update balance every 5 seconds
            balanceInterval = setInterval(() => {
                updateBalance();
            }, 5000);
            
            // Update activity every 3 seconds
            activityInterval = setInterval(() => {
                if (document.getElementById('activityTab').classList.contains('active')) {
                    loadActivityHistory();
                }
                updateStats();
            }, 3000);
        }

        // Security Functions
        function generateTwoFactorSecret() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let secret = '';
            for (let i = 0; i < 32; i++) {
                secret += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return secret;
        }

        function generateQRCodeData(secret) {
            const issuer = 'QRC Wallet';
            const accountName = walletState.address ? walletState.address.substring(0, 8) + '...' : 'QRC Account';
            return `otpauth://totp/${encodeURIComponent(issuer)}:${encodeURIComponent(accountName)}?secret=${secret}&issuer=${encodeURIComponent(issuer)}`;
        }

        function setup2FA() {
            if (walletState.twoFactorEnabled) {
                showNotification('2FA is already enabled', 'warning');
                return;
            }
            
            try {
                // Generate new secret
                const secret = generateTwoFactorSecret();
                walletState.twoFactorSecret = secret;
                
                const qrData = generateQRCodeData(secret);
                
                // Update the manual code display
                document.getElementById('manualCode').textContent = secret.match(/.{1,4}/g).join(' ');
                
                // Generate QR code
                const qrContainer = document.getElementById('qrCodeContainer');
                qrContainer.innerHTML = ''; // Clear previous QR code
                
                new QRCode(qrContainer, {
                    text: qrData,
                    width: 200,
                    height: 200,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                // Show the modal
                document.getElementById('twoFactorModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error setting up 2FA:', error);
                showNotification('Error setting up 2FA. Please try again.', 'error');
            }
        }

        function verify2FA() {
            const code = document.getElementById('twoFactorCode').value;
            
            if (!code || code.length !== 6) {
                showNotification('Please enter a 6-digit code', 'error');
                return;
            }
            
            // Verify the code
            if (verifyTOTP(walletState.twoFactorSecret, code)) {
                walletState.twoFactorEnabled = true;
                
                // Log activity
                logActivity('security', '2FA Enabled', {
                    message: 'Two-factor authentication activated'
                });
                
                // Save updated wallet state
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
                localStorage.setItem('qrcWalletEncrypted', encrypted);
                
                document.getElementById('twoFactorStatus').className = 'status-indicator status-enabled';
                document.getElementById('securityStatusText').textContent = 'Secured with password + 2FA + encryption';
                closeModal('twoFactorModal');
                showNotification('2FA enabled successfully! Make sure to save your backup codes.', 'success');
                generateBackupCodes();
                
                // Clear the form
                document.getElementById('twoFactorCode').value = '';
            } else {
                showNotification('Invalid code. Please check your authenticator app and try again.', 'error');
            }
        }

        function disable2FA() {
            if (!walletState.twoFactorEnabled) {
                showNotification('2FA is not currently enabled', 'warning');
                return;
            }
            
            showNotification('To disable 2FA, please use the Change Password section with your current 2FA code', 'info');
        }

        function generateBackupCodes() {
            const codes = [];
            for (let i = 0; i < 8; i++) {
                codes.push(Math.random().toString(36).substr(2, 8).toUpperCase());
            }
            
            walletState.backupCodes = codes;
            
            // Save updated wallet state
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
            localStorage.setItem('qrcWalletEncrypted', encrypted);
            
            return codes;
        }

        function showBackupCodes() {
            const codes = walletState.backupCodes || [];
            const codesList = document.getElementById('backupCodesList');
            
            if (codes.length === 0) {
                codesList.innerHTML = '<p>No backup codes available. Please regenerate them.</p>';
            } else {
                codesList.innerHTML = codes.map(code => 
                    `<span class="backup-code">${code}</span>`
                ).join('');
            }
            
            document.getElementById('backupCodesModal').style.display = 'flex';
        }

        function regenerateBackupCodes() {
            generateBackupCodes();
            showNotification('New backup codes generated', 'success');
            showBackupCodes();
        }

        function showChangePassword() {
            // Show/hide 2FA field based on 2FA status
            if (walletState.twoFactorEnabled) {
                document.getElementById('passwordChange2FAField').style.display = 'block';
            } else {
                document.getElementById('passwordChange2FAField').style.display = 'none';
            }
            
            document.getElementById('changePasswordModal').style.display = 'flex';
        }

        function changePassword() {
            const currentPass = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPasswordChange').value;
            const confirmPass = document.getElementById('confirmPasswordChange').value;
            const twoFactorCode = document.getElementById('passwordChange2FA').value;

            if (!currentPass || !newPass || !confirmPass) {
                showNotification('Please fill in all password fields', 'error');
                return;
            }

            if (newPass !== confirmPass) {
                showNotification('New passwords do not match', 'error');
                return;
            }

            if (newPass.length < 8) {
                showNotification('New password must be at least 8 characters long', 'error');
                return;
            }

            // Verify current password
            if (currentPass !== sessionPassword) {
                showNotification('Current password is incorrect', 'error');
                return;
            }

            // Check if new password is same as old password
            if (newPass === currentPass) {
                showNotification('New password cannot be the same as current password', 'error');
                return;
            }

            // Check 2FA if enabled
            if (walletState.twoFactorEnabled) {
                if (!twoFactorCode) {
                    showNotification('2FA code is required', 'error');
                    return;
                }
                if (!verifyTOTP(walletState.twoFactorSecret, twoFactorCode)) {
                    showNotification('Invalid 2FA code', 'error');
                    return;
                }
            }

            // Update password
            sessionPassword = newPass;
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), newPass).toString();
            localStorage.setItem('qrcWalletEncrypted', encrypted);
            
            // Log activity
            logActivity('security', 'Password Changed', {
                message: 'Wallet password successfully updated'
            });
            
            closeModal('changePasswordModal');
            showNotification('Password changed successfully', 'success');
            
            // Clear form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPasswordChange').value = '';
            document.getElementById('confirmPasswordChange').value = '';
            document.getElementById('passwordChange2FA').value = '';
        }

        function revealSeedPhrase() {
            const password = document.getElementById('seedPassword').value;
            const twoFactorCode = document.getElementById('seedPhrase2FA').value;
            
            if (!password) {
                showNotification('Please enter your password', 'error');
                return;
            }
            
            if (password !== sessionPassword) {
                showNotification('Incorrect password', 'error');
                return;
            }
            
            // Check 2FA if enabled
            if (walletState.twoFactorEnabled) {
                if (!document.getElementById('seedPhrase2FAField').style.display || document.getElementById('seedPhrase2FAField').style.display === 'none') {
                    document.getElementById('seedPhrase2FAField').style.display = 'block';
                    showNotification('Please enter your 2FA code', 'info');
                    return;
                }
                
                if (!twoFactorCode) {
                    showNotification('2FA code is required', 'error');
                    return;
                }
                if (!verifyTOTP(walletState.twoFactorSecret, twoFactorCode)) {
                    showNotification('Invalid 2FA code', 'error');
                    return;
                }
            }
            
            const grid = document.getElementById('seedWordsGrid');
            grid.innerHTML = '';
            
            walletState.seedPhrase.forEach((word, index) => {
                const wordDiv = document.createElement('div');
                wordDiv.style.cssText = 'background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; padding: 8px; text-align: center; font-family: monospace; color: #00ff88;';
                wordDiv.textContent = `${index + 1}. ${word}`;
                grid.appendChild(wordDiv);
            });
            
            document.getElementById('seedPhraseDisplay').style.display = 'block';
            
            // Log activity
            logActivity('security', 'Seed Phrase Viewed', {
                message: 'Recovery seed phrase accessed'
            });
            
            // Clear the password and 2FA fields for security
            document.getElementById('seedPassword').value = '';
            document.getElementById('seedPhrase2FA').value = '';
        }

        function showSeedPhrase() {
            // Reset the seed phrase display when opening
            document.getElementById('seedPhraseDisplay').style.display = 'none';
            document.getElementById('seedPassword').value = '';
            document.getElementById('seedPhrase2FA').value = '';
            
            // Show/hide 2FA field based on 2FA status
            if (walletState.twoFactorEnabled) {
                document.getElementById('seedPhrase2FAField').style.display = 'none'; // Hide initially
            } else {
                document.getElementById('seedPhrase2FAField').style.display = 'none';
            }
            
            document.getElementById('seedPhraseModal').style.display = 'flex';
        }

        function copySeedPhrase() {
            const seedText = walletState.seedPhrase.join(' ');
            navigator.clipboard.writeText(seedText).then(() => {
                showNotification('Seed phrase copied to clipboard', 'success');
            });
        }

        function downloadSeedPhrase() {
            const seedText = walletState.seedPhrase.join(' ');
            const blob = new Blob([seedText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'wallet-seed-phrase.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadBackupCodes() {
            const codes = walletState.backupCodes || [];
            const blob = new Blob([codes.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'backup-codes.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        function printBackupCodes() { 
            window.print(); 
        }

        // Wallet functions with BIP39 word list (partial - for demo)
        const BIP39_WORDLIST = [
            'abandon', 'ability', 'able', 'about', 'above', 'absent', 'absorb', 'abstract', 'absurd', 'abuse',
            'access', 'accident', 'account', 'accuse', 'achieve', 'acid', 'acoustic', 'acquire', 'across', 'act',
            'action', 'actor', 'actress', 'actual', 'adapt', 'add', 'addict', 'address', 'adjust', 'admit',
            'adult', 'advance', 'advice', 'aerobic', 'affair', 'afford', 'afraid', 'again', 'age', 'agent',
            'agree', 'ahead', 'aim', 'air', 'airport', 'aisle', 'alarm', 'album', 'alcohol', 'alert',
            'alien', 'all', 'alley', 'allow', 'almost', 'alone', 'alpha', 'already', 'also', 'alter',
            'always', 'amateur', 'amazing', 'among', 'amount', 'amused', 'analyst', 'anchor', 'ancient', 'anger',
            'angle', 'angry', 'animal', 'ankle', 'announce', 'annual', 'another', 'answer', 'antenna', 'antique',
            'anxiety', 'any', 'apart', 'apology', 'appear', 'apple', 'approve', 'april', 'arch', 'arctic',
            'area', 'arena', 'argue', 'arm', 'armed', 'armor', 'army', 'around', 'arrange', 'arrest',
            'arrive', 'arrow', 'art', 'artefact', 'artist', 'artwork', 'ask', 'aspect', 'assault', 'asset',
            'assist', 'assume', 'asthma', 'athlete', 'atom', 'attack', 'attend', 'attitude', 'attract', 'auction',
            'audit', 'august', 'aunt', 'author', 'auto', 'autumn', 'average', 'avocado', 'avoid', 'awake',
            'aware', 'away', 'awesome', 'awful', 'awkward', 'axis', 'baby', 'bachelor', 'bacon', 'badge',
            'bag', 'balance', 'balcony', 'ball', 'bamboo', 'banana', 'banner', 'bar', 'barely', 'bargain',
            'barrel', 'base', 'basic', 'basket', 'battle', 'beach', 'bean', 'beauty', 'because', 'become',
            'beef', 'before', 'begin', 'behave', 'behind', 'believe', 'below', 'belt', 'bench', 'benefit'
        ];

        function generateSeedPhrase() {
            // Use crypto.getRandomValues for cryptographically secure randomness
            const crypto = window.crypto || window.msCrypto;
            const array = new Uint32Array(24);
            crypto.getRandomValues(array);
            
            const phrase = [];
            for (let i = 0; i < 24; i++) {
                // Use modulo to get index within wordlist range
                const index = array[i] % BIP39_WORDLIST.length;
                phrase.push(BIP39_WORDLIST[index]);
            }
            
            // Check if this seed phrase already exists (extremely unlikely but good practice)
            const existingSeed = localStorage.getItem('usedSeedPhrases') || '[]';
            const usedSeeds = JSON.parse(existingSeed);
            const seedString = phrase.join(' ');
            
            if (usedSeeds.includes(seedString)) {
                // Recursive call to generate a new one (will practically never happen)
                return generateSeedPhrase();
            }
            
            // Store this seed phrase as used
            usedSeeds.push(seedString);
            localStorage.setItem('usedSeedPhrases', JSON.stringify(usedSeeds));
            
            return phrase;
        }

        function generateRandomString(length) {
            const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function generateAddressFromSeed(seed) {
            // Simple hash of seed for demo
            let hash = 0;
            for (let i = 0; i < seed.length; i++) {
                hash = ((hash << 5) - hash) + seed.charCodeAt(i);
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36).toUpperCase().padEnd(32, '0').substring(0, 32);
        }

        function updateBalanceDisplay() {
            document.getElementById('balanceAmount').textContent = `${walletState.balance.toFixed(2)} QRC`;
            document.getElementById('balanceUSD').textContent = `≈ ${(walletState.balance * 0.001).toFixed(2)} USD`;
        }

        function updateBalance() {
            // Simulate balance updates
            // In a real app, this would fetch from the blockchain
        }

        function updateStats() {
            // For a new blockchain, start with realistic initial values
            const currentTPS = document.getElementById('currentTPS');
            const totalBlocks = document.getElementById('totalBlocks');
            const totalTransactions = document.getElementById('totalTransactions');
            const activeUsers = document.getElementById('activeUsers');
            
            // Get stored stats or use initial values
            const storedStats = localStorage.getItem('qrcStats');
            let stats = storedStats ? JSON.parse(storedStats) : {
                tps: 0,
                blocks: 1, // Genesis block
                transactions: 0,
                users: 1 // Current user
            };
            
            // Simulate realistic activity only if there are transactions
            if (walletState.transactions && walletState.transactions.length > 0) {
                // Small random TPS when active (0-10)
                stats.tps = Math.floor(Math.random() * 10);
                
                // Increment blocks slowly (1 block every ~30 seconds)
                if (Math.random() > 0.9) {
                    stats.blocks += 1;
                }
                
                // Transactions based on actual wallet transactions
                stats.transactions = walletState.transactions.length;
                
                // Users grow slowly
                if (Math.random() > 0.95 && stats.users < 100) {
                    stats.users += 1;
                }
            } else {
                // No activity when no transactions
                stats.tps = 0;
            }
            
            // Update display
            currentTPS.textContent = stats.tps;
            totalBlocks.textContent = stats.blocks.toLocaleString();
            totalTransactions.textContent = stats.transactions.toLocaleString();
            activeUsers.textContent = stats.users.toLocaleString();
            
            // Save stats
            localStorage.setItem('qrcStats', JSON.stringify(stats));
        }

        function showTab(tabName, element) {
            // Update tab styles
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Load data if needed
            if (tabName === 'activity') {
                loadActivityHistory();
            }
        }

        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + ' min ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + ' hours ago';
            
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // Faucet function
        async function getFaucet() {
            try {
                const response = await fetch('/api/faucet/claim', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        address: walletState.address
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Update balance from response
                    if (data.new_balance !== undefined) {
                        walletState.balance = data.new_balance;
                    } else {
                        // Fallback: add the amount to current balance
                        walletState.balance += (data.amount || 100);
                    }
                    
                    updateBalanceDisplay();
                    
                    // Log activity
                    logActivity('transaction', 'Faucet Claimed', {
                        type: 'received',
                        amount: data.amount || 100,
                        from: 'Test Faucet'
                    });
                    
                    showNotification(data.message || `${data.amount || 100} Test QRC received!`, 'success');
                    
                    // Save updated state
                    const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
                    localStorage.setItem('qrcWalletEncrypted', encrypted);
                } else {
                    showNotification(data.error || 'Faucet claim failed', 'error');
                }
            } catch (error) {
                console.error('Faucet error:', error);
                showNotification('Failed to connect to faucet', 'error');
            }
        }

        // Send transaction
        function showSendModal() {
            document.getElementById('sendModal').style.display = 'flex';
            updateFeeDisplay();
            
            // Show/hide 2FA field based on 2FA status
            if (walletState.twoFactorEnabled) {
                document.getElementById('transaction2FAField').style.display = 'block';
            } else {
                document.getElementById('transaction2FAField').style.display = 'none';
            }
        }

        function updateFeeDisplay() {
            const amount = parseFloat(document.getElementById('sendAmount').value) || 0;
            const fee = Math.max(amount * 0.002, 0.01);
            document.getElementById('feeDisplay').textContent = fee.toFixed(2) + ' QRC';
            document.getElementById('totalDisplay').textContent = (amount + fee).toFixed(2) + ' QRC';
        }

        function confirmSend() {
            const recipient = document.getElementById('recipientAddress').value;
            const amount = parseFloat(document.getElementById('sendAmount').value);
            const password = document.getElementById('sendPassword').value;
            const twoFactorCode = document.getElementById('transaction2FA').value;
            
            if (!recipient || !amount || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            if (password !== sessionPassword) {
                showNotification('Invalid password', 'error');
                return;
            }
            
            if (!recipient.startsWith('QRC')) {
                showNotification('Invalid address format', 'error');
                return;
            }
            
            // Check 2FA if enabled
            if (walletState.twoFactorEnabled) {
                if (!twoFactorCode) {
                    showNotification('2FA code is required', 'error');
                    return;
                }
                if (!verifyTOTP(walletState.twoFactorSecret, twoFactorCode)) {
                    showNotification('Invalid 2FA code', 'error');
                    return;
                }
            }
            
            const fee = Math.max(amount * 0.002, 0.01);
            const total = amount + fee;
            
            if (total > walletState.balance) {
                showNotification('Insufficient balance', 'error');
                return;
            }
            
            // Process transaction
            walletState.balance -= total;
            updateBalanceDisplay();
            
            // Add to transaction history
            walletState.transactions.push({
                type: 'sent',
                recipient: recipient,
                amount: amount,
                fee: fee,
                timestamp: Date.now()
            });
            
            // Save updated state
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
            localStorage.setItem('qrcWalletEncrypted', encrypted);
            
            showNotification('Transaction sent successfully!', 'success');
            closeModal('sendModal');
            
            // Clear form
            document.getElementById('recipientAddress').value = '';
            document.getElementById('sendAmount').value = '';
            document.getElementById('sendPassword').value = '';
            document.getElementById('transaction2FA').value = '';
        }

        // Receive functions
        function showReceiveModal() {
            const modal = document.getElementById('receiveModal');
            modal.style.display = 'flex';
            
            // Generate QR code
            if (receiveQrcode) {
                document.getElementById('receiveQrcode').innerHTML = '';
            }
            
            receiveQrcode = new QRCode(document.getElementById('receiveQrcode'), {
                text: walletState.address,
                width: 200,
                height: 200,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
            
            document.getElementById('receiveAddress').textContent = walletState.address;
        }

        function showQRModal() {
            const modal = document.getElementById('qrModal');
            modal.style.display = 'flex';
            
            if (qrcode) {
                document.getElementById('qrcode').innerHTML = '';
            }
            
            qrcode = new QRCode(document.getElementById('qrcode'), {
                text: walletState.address,
                width: 200,
                height: 200,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
            
            document.getElementById('qrAddress').textContent = walletState.address;
        }

        function copyAddress() {
            navigator.clipboard.writeText(walletState.address);
            showNotification('Address copied to clipboard!', 'success');
        }

        function showCurrentPassword() {
            if (!walletState.twoFactorEnabled) {
                showNotification('Please enable 2FA first to use this feature', 'warning');
                return;
            }
            
            document.getElementById('passwordDisplay').style.display = 'none';
            document.getElementById('showPassword2FA').value = '';
            document.getElementById('showPasswordModal').style.display = 'flex';
        }

        function verifyAndShowPassword() {
            const twoFactorCode = document.getElementById('showPassword2FA').value;
            
            if (!twoFactorCode) {
                showNotification('Please enter your 2FA code', 'error');
                return;
            }
            
            if (!verifyTOTP(walletState.twoFactorSecret, twoFactorCode)) {
                showNotification('Invalid 2FA code', 'error');
                return;
            }
            
            // Show the password
            document.getElementById('currentPasswordDisplay').textContent = sessionPassword;
            document.getElementById('passwordDisplay').style.display = 'block';
            showNotification('Password revealed. Close this window when done.', 'success');
            
            // Clear the 2FA field
            document.getElementById('showPassword2FA').value = '';
        }

        function copyCurrentPassword() {
            navigator.clipboard.writeText(sessionPassword).then(() => {
                showNotification('Password copied to clipboard', 'success');
            });
        }

        // Activity Logging Functions
        function logActivity(type, action, details = {}) {
            if (!walletState.activityLog) {
                walletState.activityLog = [];
            }
            
            const activity = {
                id: 'ACT_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                type: type,
                action: action,
                details: details,
                timestamp: Date.now(),
                address: walletState.address
            };
            
            walletState.activityLog.push(activity);
            
            // Keep only last 1000 activities
            if (walletState.activityLog.length > 1000) {
                walletState.activityLog = walletState.activityLog.slice(-1000);
            }
            
            // Save state if logged in
            if (walletState.isLoggedIn && sessionPassword) {
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
                localStorage.setItem('qrcWalletEncrypted', encrypted);
            }
            
            // Update UI if activity tab is active
            if (document.getElementById('activityTab').classList.contains('active')) {
                loadActivityHistory();
            }
        }

        function loadActivityHistory() {
            const container = document.getElementById('activityHistory');
            const filter = document.getElementById('activityFilter').value;
            
            if (!walletState.activityLog || walletState.activityLog.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📊</div>
                        <p>No activities yet</p>
                        <p style="font-size: 14px; margin-top: 10px;">Your activity history will appear here</p>
                    </div>
                `;
                return;
            }
            
            // Filter activities
            let activities = [...walletState.activityLog];
            if (filter !== 'all') {
                activities = activities.filter(act => act.type === filter);
            }
            
            // Sort by timestamp (newest first)
            activities.sort((a, b) => b.timestamp - a.timestamp);
            
            // Group by date
            const groupedActivities = {};
            activities.forEach(activity => {
                const date = new Date(activity.timestamp).toLocaleDateString();
                if (!groupedActivities[date]) {
                    groupedActivities[date] = [];
                }
                groupedActivities[date].push(activity);
            });
            
            // Render activities
            let html = '';
            Object.keys(groupedActivities).forEach(date => {
                html += `<div style="margin-bottom: 20px;">`;
                html += `<h4 style="color: #999; font-size: 14px; margin-bottom: 10px;">${date}</h4>`;
                
                groupedActivities[date].forEach(activity => {
                    const time = new Date(activity.timestamp).toLocaleTimeString();
                    const { icon, color, title, description } = formatActivity(activity);
                    
                    html += `
                        <div class="transaction-item" style="border-left: 3px solid ${color};">
                            <div class="transaction-icon ${activity.type === 'transaction' && activity.details.type === 'received' ? 'received' : activity.type === 'transaction' && activity.details.type === 'sent' ? 'sent' : ''}" style="background: ${color}20; color: ${color};">
                                ${icon}
                            </div>
                            <div class="transaction-details">
                                <div class="transaction-type">${title}</div>
                                <div class="transaction-address">${description}</div>
                                <div class="transaction-time">${time}</div>
                            </div>
                            ${activity.type === 'transaction' ? `
                                <div class="transaction-amount">
                                    <div class="transaction-value ${activity.details.type === 'received' ? 'positive' : 'negative'}">
                                        ${activity.details.type === 'received' ? '+' : '-'}${activity.details.amount} QRC
                                    </div>
                                    <div class="transaction-usd">≈ ${(activity.details.amount * 0.001).toFixed(2)} USD</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }

        function formatActivity(activity) {
            let icon, color, title, description;
            
            switch (activity.type) {
                case 'transaction':
                    if (activity.details.type === 'sent') {
                        icon = '📤';
                        color = '#ff6b6b';
                        title = 'Sent QRC';
                        description = `To: ${activity.details.recipient.substring(0, 12)}...`;
                    } else if (activity.details.type === 'received') {
                        icon = '📥';
                        color = '#00ff88';
                        title = 'Received QRC';
                        description = activity.details.from ? `From: ${activity.details.from.substring(0, 12)}...` : 'From: Faucet';
                    }
                    break;
                    
                case 'security':
                    icon = '🔒';
                    color = '#ffa500';
                    title = activity.action;
                    description = activity.details.message || '';
                    break;
                    
                case 'login':
                    icon = activity.action === 'Login' ? '🔓' : '🔒';
                    color = activity.action === 'Login' ? '#00ff88' : '#999';
                    title = activity.action;
                    description = activity.details.device || '';
                    break;
                    
                case 'settings':
                    icon = '⚙️';
                    color = '#3498db';
                    title = activity.action;
                    description = activity.details.message || '';
                    break;
                    
                default:
                    icon = '📌';
                    color = '#999';
                    title = activity.action;
                    description = activity.details.message || '';
            }
            
            return { icon, color, title, description };
        }

        function filterActivity() {
            loadActivityHistory();
        }

        function exportActivityLog() {
            if (!walletState.activityLog || walletState.activityLog.length === 0) {
                showNotification('No activities to export', 'warning');
                return;
            }
            
            let csvContent = 'Date,Time,Type,Action,Details,Amount\n';
            
            walletState.activityLog.forEach(activity => {
                const date = new Date(activity.timestamp).toLocaleDateString();
                const time = new Date(activity.timestamp).toLocaleTimeString();
                const details = activity.details.message || activity.details.recipient || activity.details.from || '';
                const amount = activity.details.amount || '';
                
                csvContent += `"${date}","${time}","${activity.type}","${activity.action}","${details}","${amount}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `qrc-wallet-activity-${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Activity log exported', 'success');
        }
        function verifySeedPhrase() {
            if (!walletState.seedPhrase || walletState.seedPhrase.length !== 24) {
                showNotification('No valid seed phrase found', 'error');
                return;
            }
            
            // Generate 4 random positions to verify (words 1-24)
            const positions = [];
            while (positions.length < 4) {
                const pos = Math.floor(Math.random() * 24);
                if (!positions.includes(pos)) {
                    positions.push(pos);
                }
            }
            positions.sort((a, b) => a - b);
            
            // Store verification data
            window.seedVerificationData = {
                positions: positions,
                correctWords: positions.map(pos => walletState.seedPhrase[pos])
            };
            
            // Build verification form
            const questionsDiv = document.getElementById('verificationQuestions');
            questionsDiv.innerHTML = '';
            
            positions.forEach((pos, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'input-group';
                questionDiv.innerHTML = `
                    <label class="input-label">Word #${pos + 1}:</label>
                    <input type="text" class="input-field" id="verifyWord${index}" placeholder="Enter word #${pos + 1}" autocomplete="off">
                `;
                questionsDiv.appendChild(questionDiv);
            });
            
            document.getElementById('verifySeedModal').style.display = 'flex';
        }
        
        function checkSeedVerification() {
            if (!window.seedVerificationData) {
                showNotification('Verification data not found', 'error');
                return;
            }
            
            let allCorrect = true;
            const { positions, correctWords } = window.seedVerificationData;
            
            for (let i = 0; i < positions.length; i++) {
                const inputValue = document.getElementById(`verifyWord${i}`).value.trim().toLowerCase();
                if (inputValue !== correctWords[i]) {
                    allCorrect = false;
                    document.getElementById(`verifyWord${i}`).style.borderColor = '#ff6b6b';
                } else {
                    document.getElementById(`verifyWord${i}`).style.borderColor = '#00ff88';
                }
            }
            
            if (allCorrect) {
                showNotification('✅ Seed phrase verified successfully! Your backup is correct.', 'success');
                closeModal('verifySeedModal');
                
                // Mark wallet as verified
                walletState.seedPhraseVerified = true;
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
                localStorage.setItem('qrcWalletEncrypted', encrypted);
            } else {
                showNotification('❌ Incorrect words. Please check your seed phrase backup.', 'error');
            }
            
            // Clear verification data
            delete window.seedVerificationData;
        }
        
        function exportSeedPhrase() { 
            downloadSeedPhrase(); 
        }
        // Initialize transaction limits in walletState
        function initializeTransactionLimits() {
            if (!walletState.limits) {
                walletState.limits = {
                    daily: 0,
                    perTransaction: 0,
                    whitelistEnabled: false,
                    whitelist: [],
                    dailySpent: 0,
                    dailyResetTime: new Date().setHours(24, 0, 0, 0),
                    history: []
                };
            }
        }

        // Daily Limit Functions
        function setDailyLimit() {
            initializeTransactionLimits();
            
            const currentLimit = walletState.limits.daily;
            document.getElementById('currentDailyLimit').textContent = 
                currentLimit > 0 ? `${currentLimit.toFixed(2)} QRC` : 'No limit set';
            
            // Check and reset daily spent if needed
            const now = Date.now();
            if (now >= walletState.limits.dailyResetTime) {
                walletState.limits.dailySpent = 0;
                walletState.limits.dailyResetTime = new Date().setHours(24, 0, 0, 0);
            }
            
            document.getElementById('dailySpentAmount').textContent = `${walletState.limits.dailySpent.toFixed(2)} QRC`;
            
            // Show/hide 2FA field
            if (walletState.twoFactorEnabled) {
                document.getElementById('dailyLimit2FAField').style.display = 'block';
            } else {
                document.getElementById('dailyLimit2FAField').style.display = 'none';
            }
            
            // Clear form
            document.getElementById('newDailyLimit').value = '';
            document.getElementById('dailyLimitPassword').value = '';
            document.getElementById('dailyLimit2FA').value = '';
            
            document.getElementById('dailyLimitModal').style.display = 'flex';
        }

        function saveDailyLimit() {
            const newLimit = parseFloat(document.getElementById('newDailyLimit').value) || 0;
            const password = document.getElementById('dailyLimitPassword').value;
            const twoFactorCode = document.getElementById('dailyLimit2FA').value;

            if (!password) {
                showNotification('Please enter your password', 'error');
                return;
            }

            if (password !== sessionPassword) {
                showNotification('Incorrect password', 'error');
                return;
            }

            // Check 2FA if enabled
            if (walletState.twoFactorEnabled) {
                if (!twoFactorCode) {
                    showNotification('2FA code is required', 'error');
                    return;
                }
                if (!verifyTOTP(walletState.twoFactorSecret, twoFactorCode)) {
                    showNotification('Invalid 2FA code', 'error');
                    return;
                }
            }

            // Save the limit
            const oldLimit = walletState.limits.daily;
            walletState.limits.daily = newLimit;
            
            // Add to history
            walletState.limits.history.push({
                type: 'daily_limit_change',
                oldValue: oldLimit,
                newValue: newLimit,
                timestamp: Date.now()
            });

            // Update status indicator
            updateLimitsStatusIndicator();

            // Save state
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
            localStorage.setItem('qrcWalletEncrypted', encrypted);

            closeModal('dailyLimitModal');
            showNotification(newLimit > 0 ? `Daily limit set to ${newLimit.toFixed(2)} QRC` : 'Daily limit removed', 'success');
        }

        // Transaction Limit Functions
        function setTransactionLimit() {
            initializeTransactionLimits();
            
            const currentLimit = walletState.limits.perTransaction;
            document.getElementById('currentTransactionLimit').textContent = 
                currentLimit > 0 ? `${currentLimit.toFixed(2)} QRC` : 'No limit set';
            
            // Show/hide 2FA field
            if (walletState.twoFactorEnabled) {
                document.getElementById('transactionLimit2FAField').style.display = 'block';
            } else {
                document.getElementById('transactionLimit2FAField').style.display = 'none';
            }
            
            // Clear form
            document.getElementById('newTransactionLimit').value = '';
            document.getElementById('transactionLimitPassword').value = '';
            document.getElementById('transactionLimit2FA').value = '';
            
            document.getElementById('transactionLimitModal').style.display = 'flex';
        }

        function saveTransactionLimit() {
            const newLimit = parseFloat(document.getElementById('newTransactionLimit').value) || 0;
            const password = document.getElementById('transactionLimitPassword').value;
            const twoFactorCode = document.getElementById('transactionLimit2FA').value;

            if (!password) {
                showNotification('Please enter your password', 'error');
                return;
            }

            if (password !== sessionPassword) {
                showNotification('Incorrect password', 'error');
                return;
            }

            // Check 2FA if enabled
            if (walletState.twoFactorEnabled) {
                if (!twoFactorCode) {
                    showNotification('2FA code is required', 'error');
                    return;
                }
                if (!verifyTOTP(walletState.twoFactorSecret, twoFactorCode)) {
                    showNotification('Invalid 2FA code', 'error');
                    return;
                }
            }

            // Save the limit
            const oldLimit = walletState.limits.perTransaction;
            walletState.limits.perTransaction = newLimit;
            
            // Add to history
            walletState.limits.history.push({
                type: 'transaction_limit_change',
                oldValue: oldLimit,
                newValue: newLimit,
                timestamp: Date.now()
            });

            // Update status indicator
            updateLimitsStatusIndicator();

            // Save state
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
            localStorage.setItem('qrcWalletEncrypted', encrypted);

            closeModal('transactionLimitModal');
            showNotification(newLimit > 0 ? `Transaction limit set to ${newLimit.toFixed(2)} QRC` : 'Transaction limit removed', 'success');
        }

        // Whitelist Functions
        function enableWhitelist() {
            initializeTransactionLimits();
            updateWhitelistDisplay();
            document.getElementById('whitelistModal').style.display = 'flex';
        }

        function updateWhitelistDisplay() {
            const statusText = document.getElementById('whitelistStatusText');
            const toggleText = document.getElementById('whitelistToggleText');
            
            if (walletState.limits.whitelistEnabled) {
                statusText.textContent = 'Currently enabled - Only whitelisted addresses can receive funds';
                toggleText.textContent = 'Disable';
                document.getElementById('whitelistToggle').style.background = 'rgba(255, 107, 107, 0.1)';
                document.getElementById('whitelistToggle').style.borderColor = '#ff6b6b';
                document.getElementById('whitelistToggle').style.color = '#ff6b6b';
            } else {
                statusText.textContent = 'Currently disabled - All addresses can receive funds';
                toggleText.textContent = 'Enable';
                document.getElementById('whitelistToggle').style.background = 'transparent';
                document.getElementById('whitelistToggle').style.borderColor = '#00ff88';
                document.getElementById('whitelistToggle').style.color = '#00ff88';
            }

            // Display whitelisted addresses
            const container = document.getElementById('whitelistAddresses');
            if (walletState.limits.whitelist.length === 0) {
                container.innerHTML = '<p style="color: #999;">No addresses whitelisted yet</p>';
            } else {
                container.innerHTML = walletState.limits.whitelist.map(item => `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-family: monospace; font-size: 14px; color: #00ff88; word-break: break-all; margin-bottom: 5px;">${item.address}</div>
                                ${item.label ? `<div style="font-size: 14px; color: #999;">${item.label}</div>` : ''}
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">Added: ${new Date(item.addedAt).toLocaleString()}</div>
                            </div>
                            <button class="button button-secondary" onclick="showRemoveFromWhitelistModal('${item.address}')" style="width: auto; margin: 0; padding: 8px 16px; background: rgba(255, 107, 107, 0.1); border-color: #ff6b6b; color: #ff6b6b;">Remove</button>
                        </div>
                    </div>
                `).join('');
            }
            
            // Update status indicator
            updateLimitsStatusIndicator();
        }

        function showToggleWhitelistModal() {
            const isEnabling = !walletState.limits.whitelistEnabled;
            
            document.getElementById('toggleWhitelistTitle').textContent = isEnabling ? 'Enable Address Whitelist' : 'Disable Address Whitelist';
            document.getElementById('toggleWhitelistWarning').textContent = isEnabling ? 
                'Enabling whitelist will restrict transfers to only approved addresses.' : 
                'Disabling whitelist will allow transfers to any address.';
            
            // Show/hide 2FA field
            if (walletState.twoFactorEnabled) {
                document.getElementById('toggleWhitelist2FAField').style.display = 'block';
            } else {
                document.getElementById('toggleWhitelist2FAField').style.display = 'none';
            }
            
            // Clear form
            document.getElementById('toggleWhitelistPassword').value = '';
            document.getElementById('toggleWhitelist2FA').value = '';
            
            document.getElementById('toggleWhitelistModal').style.display = 'flex';
        }

        function confirmToggleWhitelist() {
            const password = document.getElementById('toggleWhitelistPassword').value;
            const twoFactorCode = document.getElementById('toggleWhitelist2FA').value;

            if (!password) {
                showNotification('Please enter your password', 'error');
                return;
            }

            if (password !== sessionPassword) {
                showNotification('Incorrect password', 'error');
                return;
            }

            // Check 2FA if enabled
            if (walletState.twoFactorEnabled) {
                if (!twoFactorCode) {
                    showNotification('2FA code is required', 'error');
                    return;
                }
                if (!verifyTOTP(walletState.twoFactorSecret, twoFactorCode)) {
                    showNotification('Invalid 2FA code', 'error');
                    return;
                }
            }

            walletState.limits.whitelistEnabled = !walletState.limits.whitelistEnabled;
            
            // Add to history
            walletState.limits.history.push({
                type: 'whitelist_toggle',
                enabled: walletState.limits.whitelistEnabled,
                timestamp: Date.now()
            });

            // Save state
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
            localStorage.setItem('qrcWalletEncrypted', encrypted);

            closeModal('toggleWhitelistModal');
            updateWhitelistDisplay();
            showNotification(`Address whitelist ${walletState.limits.whitelistEnabled ? 'enabled' : 'disabled'}`, 'success');
        }

        function showAddToWhitelistModal() {
            const address = document.getElementById('whitelistAddress').value.trim();
            const label = document.getElementById('whitelistLabel').value.trim();

            if (!address) {
                showNotification('Please enter an address', 'error');
                return;
            }

            if (!address.startsWith('QRC')) {
                showNotification('Invalid address format', 'error');
                return;
            }

            // Check if already whitelisted
            if (walletState.limits.whitelist.some(item => item.address === address)) {
                showNotification('Address already whitelisted', 'warning');
                return;
            }

            document.getElementById('confirmWhitelistAddress').textContent = address;
            document.getElementById('confirmWhitelistLabel').textContent = label || 'No label';
            
            // Show/hide 2FA field
            if (walletState.twoFactorEnabled) {
                document.getElementById('addWhitelist2FAField').style.display = 'block';
            } else {
                document.getElementById('addWhitelist2FAField').style.display = 'none';
            }
            
            // Clear password fields
            document.getElementById('addWhitelistPassword').value = '';
            document.getElementById('addWhitelist2FA').value = '';
            
            // Store temporarily for confirmation
            window.pendingWhitelistAdd = { address, label };
            
            document.getElementById('addToWhitelistModal').style.display = 'flex';
        }

        function confirmAddToWhitelist() {
            const password = document.getElementById('addWhitelistPassword').value;
            const twoFactorCode = document.getElementById('addWhitelist2FA').value;

            if (!password) {
                showNotification('Please enter your password', 'error');
                return;
            }

            if (password !== sessionPassword) {
                showNotification('Incorrect password', 'error');
                return;
            }

            // Check 2FA if enabled
            if (walletState.twoFactorEnabled) {
                if (!twoFactorCode) {
                    showNotification('2FA code is required', 'error');
                    return;
                }
                if (!verifyTOTP(walletState.twoFactorSecret, twoFactorCode)) {
                    showNotification('Invalid 2FA code', 'error');
                    return;
                }
            }

            if (!window.pendingWhitelistAdd) {
                showNotification('Error: No pending address to add', 'error');
                return;
            }

            // Add to whitelist
            walletState.limits.whitelist.push({
                address: window.pendingWhitelistAdd.address,
                label: window.pendingWhitelistAdd.label,
                addedAt: Date.now()
            });

            // Add to history
            walletState.limits.history.push({
                type: 'whitelist_add',
                address: window.pendingWhitelistAdd.address,
                label: window.pendingWhitelistAdd.label,
                timestamp: Date.now()
            });

            // Save state
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
            localStorage.setItem('qrcWalletEncrypted', encrypted);

            // Clear form and close modals
            document.getElementById('whitelistAddress').value = '';
            document.getElementById('whitelistLabel').value = '';
            delete window.pendingWhitelistAdd;
            
            closeModal('addToWhitelistModal');
            updateWhitelistDisplay();
            showNotification('Address added to whitelist', 'success');
        }

        function showRemoveFromWhitelistModal(address) {
            // For simplicity, we'll use a confirm dialog here, but you could create another modal
            if (confirm(`Remove ${address} from whitelist?`)) {
                walletState.limits.whitelist = walletState.limits.whitelist.filter(item => item.address !== address);
                
                // Add to history
                walletState.limits.history.push({
                    type: 'whitelist_remove',
                    address: address,
                    timestamp: Date.now()
                });

                // Save state
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
                localStorage.setItem('qrcWalletEncrypted', encrypted);

                updateWhitelistDisplay();
                showNotification('Address removed from whitelist', 'success');
            }
        }

        // Limits History Function
        function viewLimitsHistory() {
            initializeTransactionLimits();
            const historyContent = document.getElementById('limitsHistoryContent');
            
            if (!walletState.limits.history || walletState.limits.history.length === 0) {
                historyContent.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">No limit changes recorded yet</p>';
            } else {
                historyContent.innerHTML = walletState.limits.history
                    .slice()
                    .reverse()
                    .map(item => {
                        let actionText = '';
                        let actionIcon = '';
                        let actionColor = '#00ff88';
                        
                        switch (item.type) {
                            case 'daily_limit_change':
                                actionText = `Daily limit changed from ${item.oldValue.toFixed(2)} QRC to ${item.newValue.toFixed(2)} QRC`;
                                actionIcon = '💰';
                                break;
                            case 'transaction_limit_change':
                                actionText = `Transaction limit changed from ${item.oldValue.toFixed(2)} QRC to ${item.newValue.toFixed(2)} QRC`;
                                actionIcon = '💸';
                                break;
                            case 'whitelist_toggle':
                                actionText = `Address whitelist ${item.enabled ? 'enabled' : 'disabled'}`;
                                actionIcon = item.enabled ? '🔒' : '🔓';
                                actionColor = item.enabled ? '#00ff88' : '#ff6b6b';
                                break;
                            case 'whitelist_add':
                                actionText = `Added ${item.address} to whitelist${item.label ? ` (${item.label})` : ''}`;
                                actionIcon = '➕';
                                break;
                            case 'whitelist_remove':
                                actionText = `Removed ${item.address} from whitelist`;
                                actionIcon = '➖';
                                actionColor = '#ff6b6b';
                                break;
                        }
                        
                        return `
                            <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid ${actionColor};">
                                <div style="display: flex; align-items: start; gap: 10px;">
                                    <div style="font-size: 24px;">${actionIcon}</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 5px;">${actionText}</div>
                                        <div style="font-size: 12px; color: #999;">${new Date(item.timestamp).toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    })
                    .join('');
            }
            
            document.getElementById('limitsHistoryModal').style.display = 'flex';
        }

        // Update status indicator for Transaction Limits
        function updateLimitsStatusIndicator() {
            const hasLimits = walletState.limits && (
                walletState.limits.daily > 0 || 
                walletState.limits.perTransaction > 0 || 
                walletState.limits.whitelistEnabled
            );
            
            const indicators = document.querySelectorAll('.security-item');
            if (indicators.length >= 5) {
                const limitsIndicator = indicators[4].querySelector('.status-indicator');
                if (limitsIndicator) {
                    limitsIndicator.className = hasLimits ? 'status-indicator status-enabled' : 'status-indicator status-disabled';
                }
            }
        }

        // Check transaction limits before sending
        function checkTransactionLimits(amount, recipient) {
            initializeTransactionLimits();
            
            // Check whitelist first
            if (walletState.limits.whitelistEnabled) {
                const isWhitelisted = walletState.limits.whitelist.some(item => item.address === recipient);
                if (!isWhitelisted) {
                    return {
                        allowed: false,
                        reason: 'Address is not whitelisted. Please add it to your whitelist first.'
                    };
                }
            }
            
            // Check per-transaction limit
            if (walletState.limits.perTransaction > 0 && amount > walletState.limits.perTransaction) {
                return {
                    allowed: false,
                    reason: `Transaction exceeds limit of ${walletState.limits.perTransaction.toFixed(2)} QRC`
                };
            }
            
            // Check daily limit
            if (walletState.limits.daily > 0) {
                // Reset daily counter if new day
                const now = Date.now();
                if (now >= walletState.limits.dailyResetTime) {
                    walletState.limits.dailySpent = 0;
                    walletState.limits.dailyResetTime = new Date().setHours(24, 0, 0, 0);
                }
                
                if (walletState.limits.dailySpent + amount > walletState.limits.daily) {
                    const remaining = walletState.limits.daily - walletState.limits.dailySpent;
                    return {
                        allowed: false,
                        reason: `Daily limit exceeded. Remaining today: ${remaining.toFixed(2)} QRC`
                    };
                }
            }
            
            return { allowed: true };
        }

        // Update confirmSend to include limit checks
        const originalConfirmSend = confirmSend;
        function confirmSend() {
            const recipient = document.getElementById('recipientAddress').value;
            const amount = parseFloat(document.getElementById('sendAmount').value);
            
            if (!recipient || !amount) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            // Initialize limits if needed
            initializeTransactionLimits();
            
            // Check transaction limits
            const limitCheck = checkTransactionLimits(amount, recipient);
            if (!limitCheck.allowed) {
                showNotification(limitCheck.reason, 'error');
                return;
            }
            
            // Store original function to call after checks
            const originalSendLogic = async () => {
                const password = document.getElementById('sendPassword').value;
                const twoFactorCode = document.getElementById('transaction2FA').value;
                
                if (!password) {
                    showNotification('Please enter your password', 'error');
                    return;
                }
                
                if (password !== sessionPassword) {
                    showNotification('Invalid password', 'error');
                    return;
                }
                
                if (!recipient.startsWith('QRC')) {
                    showNotification('Invalid address format', 'error');
                    return;
                }
                
                // Check 2FA if enabled
                if (walletState.twoFactorEnabled) {
                    if (!twoFactorCode) {
                        showNotification('2FA code is required', 'error');
                        return;
                    }
                    if (!verifyTOTP(walletState.twoFactorSecret, twoFactorCode)) {
                        showNotification('Invalid 2FA code', 'error');
                        return;
                    }
                }
                
                const fee = Math.max(amount * 0.002, 0.01);
                const total = amount + fee;
                
                if (total > walletState.balance) {
                    showNotification('Insufficient balance', 'error');
                    return;
                }
                
                // Process transaction through blockchain API
                try {
                    const response = await fetch('/api/transaction/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            sender: walletState.address,
                            recipient: recipient,
                            amount: amount,
                            fee: fee
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        // Update balance from response
                        if (data.new_balance !== undefined) {
                            walletState.balance = data.new_balance;
                        } else {
                            // Fallback to local calculation
                            walletState.balance -= total;
                        }
                        
                        // Update daily spent if limit is enabled
                        if (walletState.limits && walletState.limits.daily > 0) {
                            walletState.limits.dailySpent += amount;
                        }
                        
                        updateBalanceDisplay();
                        
                        // Add to transaction history
                        walletState.transactions.push({
                            type: 'sent',
                            recipient: recipient,
                            amount: amount,
                            fee: fee,
                            timestamp: Date.now(),
                            txHash: data.transaction_hash || null
                        });
                        
                        // Log activity
                        logActivity('transaction', 'Sent QRC', {
                            type: 'sent',
                            recipient: recipient,
                            amount: amount,
                            fee: fee,
                            txHash: data.transaction_hash
                        });
                        
                        // Save updated state
                        const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
                        localStorage.setItem('qrcWalletEncrypted', encrypted);
                        
                        showNotification(data.message || 'Transaction sent successfully!', 'success');
                        closeModal('sendModal');
                        
                        // Clear form
                        document.getElementById('recipientAddress').value = '';
                        document.getElementById('sendAmount').value = '';
                        document.getElementById('sendPassword').value = '';
                        document.getElementById('transaction2FA').value = '';
                    } else {
                        showNotification(data.error || 'Transaction failed', 'error');
                    }
                } catch (error) {
                    console.error('Transaction error:', error);
                    showNotification('Failed to send transaction', 'error');
                }
            };
            
            originalSendLogic();
        }
        // Advanced Security Functions
        
        // Initialize advanced security settings
        function initializeAdvancedSecurity() {
            if (!walletState.advancedSecurity) {
                walletState.advancedSecurity = {
                    hardwareWallet: null,
                    recoveryContacts: [],
                    recoveryThreshold: 2,
                    privateKeyExports: []
                };
            }
        }

        // Hardware Wallet Functions
        function connectHardwareWallet() {
            initializeAdvancedSecurity();
            
            // Reset selection
            document.getElementById('ledgerBtn').style.borderColor = 'rgba(255, 255, 255, 0.1)';
            document.getElementById('trezorBtn').style.borderColor = 'rgba(255, 255, 255, 0.1)';
            document.getElementById('hardwareConnectionStatus').style.display = 'none';
            document.getElementById('hardwareSecurityVerification').style.display = 'none';
            
            // Clear form
            document.getElementById('hardwarePassword').value = '';
            document.getElementById('hardware2FA').value = '';
            
            // Show/hide 2FA field
            if (walletState.twoFactorEnabled) {
                document.getElementById('hardware2FAField').style.display = 'block';
            } else {
                document.getElementById('hardware2FAField').style.display = 'none';
            }
            
            document.getElementById('hardwareWalletModal').style.display = 'flex';
        }

        function selectHardwareWallet(type) {
            // Update UI
            document.getElementById('ledgerBtn').style.borderColor = type === 'ledger' ? '#00ff88' : 'rgba(255, 255, 255, 0.1)';
            document.getElementById('trezorBtn').style.borderColor = type === 'trezor' ? '#00ff88' : 'rgba(255, 255, 255, 0.1)';
            
            // Show connection status
            document.getElementById('hardwareConnectionStatus').style.display = 'block';
            document.getElementById('connectionStatusText').innerHTML = `<span style="color: #ffa500;">🔄 Searching for ${type === 'ledger' ? 'Ledger' : 'Trezor'} device...</span>`;
            
            // Store selected type
            window.selectedHardwareType = type;
            
            // Simulate device detection (in real implementation, this would use WebUSB/WebHID)
            setTimeout(() => {
                document.getElementById('connectionStatusText').innerHTML = `<span style="color: #00ff88;">✅ ${type === 'ledger' ? 'Ledger' : 'Trezor'} device detected</span>`;
                document.getElementById('connectionProgress').innerHTML = `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 8px; margin-top: 10px;">
                        <div style="font-size: 12px; color: #999;">Device: ${type === 'ledger' ? 'Ledger Nano X' : 'Trezor Model T'}</div>
                        <div style="font-size: 12px; color: #999;">Firmware: v2.1.0</div>
                    </div>
                `;
                document.getElementById('hardwareSecurityVerification').style.display = 'block';
            }, 2000);
        }

        function confirmHardwareConnection() {
            const password = document.getElementById('hardwarePassword').value;
            const twoFactorCode = document.getElementById('hardware2FA').value;

            if (!password) {
                showNotification('Please enter your password', 'error');
                return;
            }

            if (password !== sessionPassword) {
                showNotification('Incorrect password', 'error');
                return;
            }

            // Check 2FA if enabled
            if (walletState.twoFactorEnabled) {
                if (!twoFactorCode) {
                    showNotification('2FA code is required', 'error');
                    return;
                }
                if (!verifyTOTP(walletState.twoFactorSecret, twoFactorCode)) {
                    showNotification('Invalid 2FA code', 'error');
                    return;
                }
            }

            if (!window.selectedHardwareType) {
                showNotification('Please select a hardware wallet', 'error');
                return;
            }

            // Save hardware wallet connection
            walletState.advancedSecurity.hardwareWallet = {
                type: window.selectedHardwareType,
                connectedAt: Date.now(),
                deviceId: 'HW_' + generateRandomString(16),
                status: 'connected'
            };

            // Save state
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
            localStorage.setItem('qrcWalletEncrypted', encrypted);

            closeModal('hardwareWalletModal');
            showNotification(`${window.selectedHardwareType === 'ledger' ? 'Ledger' : 'Trezor'} successfully connected!`, 'success');
            
            delete window.selectedHardwareType;
        }

        // Recovery Contacts Functions
        function setRecoveryContacts() {
            initializeAdvancedSecurity();
            updateRecoveryContactsList();
            
            // Clear form
            document.getElementById('recoveryContactName').value = '';
            document.getElementById('recoveryContactEmail').value = '';
            document.getElementById('recoveryContactAddress').value = '';
            document.getElementById('recoveryThreshold').value = walletState.advancedSecurity.recoveryThreshold || 2;
            
            document.getElementById('recoveryContactsModal').style.display = 'flex';
        }

        function updateRecoveryContactsList() {
            const container = document.getElementById('recoveryContactsList');
            
            if (!walletState.advancedSecurity.recoveryContacts || walletState.advancedSecurity.recoveryContacts.length === 0) {
                container.innerHTML = '<p style="color: #999;">No recovery contacts set</p>';
            } else {
                container.innerHTML = walletState.advancedSecurity.recoveryContacts.map(contact => `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 5px;">${contact.name}</div>
                                <div style="font-size: 14px; color: #999; margin-bottom: 3px;">${contact.email}</div>
                                ${contact.address ? `<div style="font-size: 12px; color: #666; font-family: monospace;">${contact.address}</div>` : ''}
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">Added: ${new Date(contact.addedAt).toLocaleString()}</div>
                            </div>
                            <button class="button button-secondary" onclick="removeRecoveryContact('${contact.id}')" style="width: auto; margin: 0; padding: 8px 16px; background: rgba(255, 107, 107, 0.1); border-color: #ff6b6b; color: #ff6b6b;">Remove</button>
                        </div>
                    </div>
                `).join('');
                
                // Update threshold info
                const threshold = walletState.advancedSecurity.recoveryThreshold;
                const totalContacts = walletState.advancedSecurity.recoveryContacts.length;
                container.innerHTML += `
                    <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong>Recovery Requirements:</strong> ${threshold} of ${totalContacts} contacts needed for recovery
                    </div>
                `;
            }
        }

        function showAddRecoveryContactModal() {
            const name = document.getElementById('recoveryContactName').value.trim();
            const email = document.getElementById('recoveryContactEmail').value.trim();
            const address = document.getElementById('recoveryContactAddress').value.trim();
            const threshold = parseInt(document.getElementById('recoveryThreshold').value);

            if (!name || !email) {
                showNotification('Please enter name and email', 'error');
                return;
            }

            // Validate email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showNotification('Please enter a valid email address', 'error');
                return;
            }

            // Validate wallet address if provided
            if (address && !address.startsWith('QRC')) {
                showNotification('Invalid wallet address format', 'error');
                return;
            }

            // Update threshold
            walletState.advancedSecurity.recoveryThreshold = threshold;

            // Show confirmation
            document.getElementById('confirmRecoveryName').textContent = name;
            document.getElementById('confirmRecoveryEmail').textContent = email;
            
            if (address) {
                document.getElementById('confirmRecoveryAddressDiv').style.display = 'block';
                document.getElementById('confirmRecoveryAddress').textContent = address;
            } else {
                document.getElementById('confirmRecoveryAddressDiv').style.display = 'none';
            }

            // Show/hide 2FA field
            if (walletState.twoFactorEnabled) {
                document.getElementById('addRecovery2FAField').style.display = 'block';
            } else {
                document.getElementById('addRecovery2FAField').style.display = 'none';
            }

            // Clear password fields
            document.getElementById('addRecoveryPassword').value = '';
            document.getElementById('addRecovery2FA').value = '';

            // Store temporarily
            window.pendingRecoveryContact = { name, email, address };

            document.getElementById('addRecoveryContactModal').style.display = 'flex';
        }

        function confirmAddRecoveryContact() {
            const password = document.getElementById('addRecoveryPassword').value;
            const twoFactorCode = document.getElementById('addRecovery2FA').value;

            if (!password) {
                showNotification('Please enter your password', 'error');
                return;
            }

            if (password !== sessionPassword) {
                showNotification('Incorrect password', 'error');
                return;
            }

            // Check 2FA if enabled
            if (walletState.twoFactorEnabled) {
                if (!twoFactorCode) {
                    showNotification('2FA code is required', 'error');
                    return;
                }
                if (!verifyTOTP(walletState.twoFactorSecret, twoFactorCode)) {
                    showNotification('Invalid 2FA code', 'error');
                    return;
                }
            }

            if (!window.pendingRecoveryContact) {
                showNotification('Error: No pending contact to add', 'error');
                return;
            }

            // Add recovery contact
            const contact = {
                id: 'RC_' + Date.now(),
                name: window.pendingRecoveryContact.name,
                email: window.pendingRecoveryContact.email,
                address: window.pendingRecoveryContact.address,
                addedAt: Date.now(),
                status: 'active'
            };

            walletState.advancedSecurity.recoveryContacts.push(contact);

            // Save state
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
            localStorage.setItem('qrcWalletEncrypted', encrypted);

            // Clear and close
            delete window.pendingRecoveryContact;
            closeModal('addRecoveryContactModal');
            updateRecoveryContactsList();
            
            // Clear form
            document.getElementById('recoveryContactName').value = '';
            document.getElementById('recoveryContactEmail').value = '';
            document.getElementById('recoveryContactAddress').value = '';
            
            showNotification('Recovery contact added successfully', 'success');
        }

        function removeRecoveryContact(contactId) {
            if (confirm('Remove this recovery contact?')) {
                walletState.advancedSecurity.recoveryContacts = 
                    walletState.advancedSecurity.recoveryContacts.filter(c => c.id !== contactId);

                // Save state
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
                localStorage.setItem('qrcWalletEncrypted', encrypted);

                updateRecoveryContactsList();
                showNotification('Recovery contact removed', 'success');
            }
        }

        // Export Private Key Functions
        function exportPrivateKey() {
            initializeAdvancedSecurity();
            
            // Reset checkboxes
            document.getElementById('privateKeyCheck1').checked = false;
            document.getElementById('privateKeyCheck2').checked = false;
            document.getElementById('privateKeyCheck3').checked = false;
            
            // Hide private key display
            document.getElementById('privateKeyDisplay').style.display = 'none';
            
            // Clear form
            document.getElementById('exportPrivateKeyPassword').value = '';
            document.getElementById('exportPrivateKey2FA').value = '';
            
            // Show/hide 2FA field
            if (walletState.twoFactorEnabled) {
                document.getElementById('exportPrivateKey2FAField').style.display = 'block';
            } else {
                document.getElementById('exportPrivateKey2FAField').style.display = 'none';
            }
            
            document.getElementById('exportPrivateKeyModal').style.display = 'flex';
        }

        function revealPrivateKey() {
            const password = document.getElementById('exportPrivateKeyPassword').value;
            const twoFactorCode = document.getElementById('exportPrivateKey2FA').value;
            
            // Check all checkboxes
            const check1 = document.getElementById('privateKeyCheck1').checked;
            const check2 = document.getElementById('privateKeyCheck2').checked;
            const check3 = document.getElementById('privateKeyCheck3').checked;
            
            if (!check1 || !check2 || !check3) {
                showNotification('Please confirm all security checkpoints', 'error');
                return;
            }

            if (!password) {
                showNotification('Please enter your password', 'error');
                return;
            }

            if (password !== sessionPassword) {
                showNotification('Incorrect password', 'error');
                return;
            }

            // Check 2FA if enabled
            if (walletState.twoFactorEnabled) {
                if (!twoFactorCode) {
                    showNotification('2FA code is required', 'error');
                    return;
                }
                if (!verifyTOTP(walletState.twoFactorSecret, twoFactorCode)) {
                    showNotification('Invalid 2FA code', 'error');
                    return;
                }
            }

            // Generate private key from seed phrase (simplified for demo)
            const privateKey = generatePrivateKeyFromSeed(walletState.seedPhrase.join(' '));
            
            // Record export
            walletState.advancedSecurity.privateKeyExports.push({
                timestamp: Date.now(),
                method: 'manual'
            });
            
            // Log activity
            logActivity('security', 'Private Key Exported', {
                message: 'Private key accessed and revealed'
            });

            // Save state
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(walletState), sessionPassword).toString();
            localStorage.setItem('qrcWalletEncrypted', encrypted);

            // Display private key
            document.getElementById('privateKeyValue').textContent = privateKey;
            document.getElementById('privateKeyDisplay').style.display = 'block';
            document.getElementById('revealPrivateKeyBtn').style.display = 'none';
            
            showNotification('Private key revealed. Keep it safe!', 'warning');
        }

        function generatePrivateKeyFromSeed(seedPhrase) {
            // This is a simplified version. In production, use proper key derivation
            const hash = CryptoJS.SHA256(seedPhrase + walletState.address);
            return hash.toString();
        }

        function copyPrivateKey() {
            const privateKey = document.getElementById('privateKeyValue').textContent;
            navigator.clipboard.writeText(privateKey).then(() => {
                showNotification('Private key copied to clipboard', 'success');
            });
        }

        function downloadPrivateKey() {
            const privateKey = document.getElementById('privateKeyValue').textContent;
            const content = `QRC Wallet Private Key
Generated: ${new Date().toISOString()}
Address: ${walletState.address}

PRIVATE KEY:
${privateKey}

WARNING: Keep this file secure and offline!`;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `qrc-wallet-private-key-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Private key downloaded', 'success');
        }

        function hidePrivateKey() {
            document.getElementById('privateKeyDisplay').style.display = 'none';
            document.getElementById('revealPrivateKeyBtn').style.display = 'block';
            document.getElementById('exportPrivateKeyPassword').value = '';
            document.getElementById('exportPrivateKey2FA').value = '';
        }
        
        function enableMultisig() { 
            // Function removed as requested
        }

        // Wallet Integration Functions
        async function connectMetaMask() {
            showNotification('MetaMask integration in progress', 'info');
        }
        
        // Check for existing session on load
        window.onload = function() {
            document.getElementById('walletPassword').value = '';
            document.getElementById('login2FA').value = '';
            document.getElementById('login2FAField').style.display = 'none';
            
            const hasWallet = localStorage.getItem('qrcWalletEncrypted');
            if (!hasWallet) {
                showNotification('Welcome! Create a new wallet to get started.', 'info');
            }
        };
    </script>
</body>
</html>